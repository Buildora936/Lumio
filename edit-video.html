<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lumio Studio – Modifier la vidéo</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const id = new URLSearchParams(location.search).get("id");

const titleInput = document.getElementById("title");
const descInput = document.getElementById("description");
const thumbPreview = document.getElementById("thumbPreview");
const thumbInput = document.getElementById("thumb");
const commentsToggle = document.getElementById("comments");
const publicToggle = document.getElementById("public");

onAuthStateChanged(auth, async user => {
  if (!user || !id) {
    location.href = "studio.html";
    return;
  }

  const snap = await get(ref(db, "videos/" + id));
  if (!snap.exists() || snap.val().creatorId !== user.uid) {
    alert("Accès refusé");
    location.href = "studio.html";
    return;
  }

  const v = snap.val();

  titleInput.value = v.title;
  descInput.value = v.description || "";
  thumbPreview.src = v.thumbnailBase64;
  commentsToggle.checked = v.commentsEnabled;
  publicToggle.checked = v.isPublic;

  document.getElementById("stats").innerHTML = `
    ${v.views || 0} vues • ${v.likes || 0} likes • ${v.dislikes || 0} dislikes
  `;
});

thumbInput.onchange = () => {
  const file = thumbInput.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => thumbPreview.src = reader.result;
  reader.readAsDataURL(file);
};

window.save = async () => {
  await update(ref(db, "videos/" + id), {
    title: titleInput.value.trim(),
    description: descInput.value.trim(),
    thumbnailBase64: thumbPreview.src,
    commentsEnabled: commentsToggle.checked,
    isPublic: publicToggle.checked
  });

  alert("Modifications enregistrées");
};
</script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#181818;
  color:white;
}
header{
  height:56px;
  background:#0f0f0f;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}
header h1{font-size:18px}

button{
  background:#ff8800;
  color:black;
  border:none;
  padding:10px 16px;
  border-radius:20px;
  font-weight:600;
  cursor:pointer;
}
button:hover{background:#ffaa33}

.container{
  padding:16px;
  max-width:720px;
  margin:auto;
}

label{
  display:block;
  margin-top:16px;
  font-size:13px;
  color:#ccc;
}

input, textarea{
  width:100%;
  background:#202020;
  border:none;
  color:white;
  padding:12px;
  border-radius:12px;
  margin-top:6px;
  font-size:14px;
}

textarea{min-height:120px;resize:vertical}

.thumb{
  margin-top:12px;
}
.thumb img{
  width:100%;
  max-width:320px;
  border-radius:12px;
  display:block;
  background:#000;
}

.switch{
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:12px;
}

.stats{
  margin-top:16px;
  font-size:13px;
  color:#aaa;
}
</style>
</head>

<body>

<header>
  <h1>Modifier la vidéo</h1>
  <button onclick="save()">Enregistrer</button>
</header>

<div class="container">

  <div class="stats" id="stats"></div>

  <label>Titre</label>
  <input id="title" maxlength="100">

  <label>Description</label>
  <textarea id="description"></textarea>

  <label>Miniature</label>
  <div class="thumb">
    <img id="thumbPreview">
    <input type="file" id="thumb" accept="image/*">
  </div>

  <div class="switch">
    <input type="checkbox" id="comments">
    <label for="comments">Autoriser les commentaires</label>
  </div>

  <div class="switch">
    <input type="checkbox" id="public">
    <label for="public">Vidéo publique</label>
  </div>

</div>

</body>
</html>
