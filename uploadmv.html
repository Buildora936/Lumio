<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Publier MV – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from
 "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, push, set }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
});

const auth = getAuth(app);
const db = getDatabase(app);

let channelId=null, channelName="", channelPhotoURL="";

onAuthStateChanged(auth, async user=>{
  if(!user){ location.href="auth.html"; return; }

  const uc = await get(ref(db,"userChannels/"+user.uid));
  if(!uc.exists()){ location.href="add-channel.html"; return; }

  channelId = uc.val();

  const ch = await get(ref(db,"channels/"+channelId));
  const c = ch.val();
  channelName = c.name;
  channelPhotoURL = c.photoURL;
});

// base64 AVEC PROGRESSION
const toBase64Progress = (file, cb)=>new Promise((res,rej)=>{
  const r=new FileReader();
  r.onprogress=e=>{
    if(e.lengthComputable){
      cb(Math.round((e.loaded/e.total)*100));
    }
  };
  r.onload=()=>res(r.result);
  r.onerror=e=>rej(e);
  r.readAsDataURL(file);
});

window.onload=()=>{
 const form=document.getElementById("uploadForm");
 const bar=document.getElementById("bar");
 const status=document.getElementById("status");
 const btn=document.getElementById("submitBtn");

 form.onsubmit=async e=>{
  e.preventDefault();

  const title=titleInput.value.trim();
  const description=descriptionInput.value.trim();
  const video=videoInput.files[0];
  const thumb=thumbnailInput.files[0];
  const allowComments=comments.checked;

  if(!title||!video||!thumb){ alert("Champs manquants"); return; }

  btn.disabled=true;
  status.textContent="Encodage du short…";

  try{
    let vProgress=0, tProgress=0;

    const videoBase64 = await toBase64Progress(video,p=>{
      vProgress=p;
      bar.style.width=((vProgress+tProgress)/2)+"%";
    });

    status.textContent="Encodage de la miniature…";

    const thumbBase64 = await toBase64Progress(thumb,p=>{
      tProgress=p;
      bar.style.width=((vProgress+tProgress)/2)+"%";
    });

    status.textContent="Publication sur Lumio…";
    bar.style.width="90%";

    const refShort=push(ref(db,"shorts"));

    await set(refShort,{
      type:"short",
      title,
      description,
      videoURL: videoBase64,
      thumbnailBase64: thumbBase64,

      channelId,
      channelName,
      channelPhotoURL,

      allowComments,
      createdAt:Date.now(),
      views:0,
      likes:0
    });

    await set(ref(db,`channels/${channelId}/shorts/${refShort.key}`),true);

    bar.style.width="100%";
    status.textContent="Short publié avec succès ✔";

    setTimeout(()=>location.href="index.html",1200);

  }catch(err){
    console.error(err);
    alert(err.message);
    btn.disabled=false;
  }
 };
};
</script>

<style>
*{box-sizing:border-box}
body{
 margin:0;
 font-family:system-ui;
 background:#181818;
 color:white;
}

/* HEADER */
header{
 position:fixed;top:0;left:0;right:0;height:56px;
 background:#0f0f0f;
 display:flex;align-items:center;justify-content:space-between;
 padding:0 16px;z-index:10;
}
header h1{font-size:20px}
header button{
 background:#202020;color:white;border:none;
 padding:6px 12px;border-radius:12px;
}

/* CONTENT */
main{
 margin-top:72px;
 padding:16px;
 max-width:600px;
 margin:auto;
}

form{display:flex;flex-direction:column;gap:16px}
label{font-weight:600}
input,textarea{
 padding:8px;border-radius:10px;
 border:none;background:#222;color:white;
}
textarea{height:100px;resize:none}

button.submit-btn{
 background:#ff8800;
 color:white;border:none;
 padding:12px;border-radius:20px;
 font-weight:600;
 cursor:pointer;
}
button.submit-btn:disabled{
 opacity:.6;cursor:not-allowed;
}

/* PROGRESS */
.progress{
 height:8px;
 background:#222;
 border-radius:20px;
 overflow:hidden;
 margin-top:10px;
}
.progress div{
 height:100%;
 width:0%;
 background:#ff8800;
 transition:.2s;
}
.status{
 font-size:13px;
 margin-top:6px;
 color:#aaa;
}
</style>
</head>

<body>

<header>
 <h1>Publier un MV</h1>
 <button onclick="location.href='index.html'">
  <i class="fa-solid fa-arrow-left"></i>
 </button>
</header>

<main>
 <form id="uploadForm">

  <label>Titre</label>
  <input id="titleInput" placeholder="Titre du short">

  <label>Description</label>
  <textarea id="descriptionInput" placeholder="Description du short"></textarea>

  <label>Thumbnail</label>
  <input id="thumbnailInput" type="file" accept="image/*">

  <label>Vidéo verticale (Short)</label>
  <input id="videoInput" type="file" accept="video/*">

  <label>
   <input id="comments" type="checkbox" checked>
   Autoriser les commentaires
  </label>

  <button id="submitBtn" class="submit-btn">Publier</button>

  <div class="progress"><div id="bar"></div></div>
  <div class="status" id="status"></div>

 </form>
</main>

</body>
</html>
