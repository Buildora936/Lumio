<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Publier un Short – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#181818;
  color:white;
}
.container{
  max-width:600px;
  margin:40px auto;
  padding:20px;
  background:#0f0f0f;
  border-radius:16px;
}
h2{text-align:center;color:#ff9800}
input,textarea,button{
  width:100%;
  margin:8px 0;
  padding:12px;
  border-radius:10px;
  border:none;
  background:#1f1f1f;
  color:white;
}
textarea{resize:none;height:100px}
button{
  background:#ff9800;
  color:black;
  font-weight:700;
  cursor:pointer;
}
.progress{
  width:100%;
  height:18px;
  background:#202020;
  border-radius:10px;
  overflow:hidden;
}
.bar{
  height:100%;
  width:0%;
  background:#ff9800;
}
.error{color:#ff5555;text-align:center}
</style>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig={
  apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain:"lumio-6efed.firebaseapp.com",
  databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId:"lumio-6efed"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const auth=getAuth(app);

/* ================= SUPABASE ================= */
const SUPABASE_URL="https://ymcrkbcsuloijemdbqzy.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltY3JrYmNzdWxvaWplbWRicXp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTg0OTUsImV4cCI6MjA4NTg5NDQ5NX0.DH7S5cdFSwD5i1RNs_QYyubJUar8ANtdEImyj1ZqOjw";
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

/* ================= STATE ================= */
let currentUser=null, channelId=null, channelName="", channelPhotoURL="";

const bar=document.getElementById("progressBar");
const errorBox=document.getElementById("error");
const setProgress=p=>bar.style.width=p+"%";

/* ================= AUTH ================= */
onAuthStateChanged(auth,async user=>{
  if(!user) return location.href="auth.html";
  currentUser=user;

  const uc=await get(ref(db,"userChannels/"+user.uid));
  if(!uc.exists()) return location.href="add-channel.html";

  channelId=uc.val();
  const ch=await get(ref(db,"channels/"+channelId));
  const c=ch.val();

  channelName=c.name;
  channelPhotoURL=c.photoURL;
  channelNameBox.textContent=channelName;
});

/* ================= UPLOAD SHORT ================= */
uploadForm.onsubmit=async e=>{
 e.preventDefault();
 errorBox.textContent="";
 setProgress(0);

 const title=titleInput.value.trim();
 const description=descInput.value.trim();
 const videoFile=videoInput.files[0];
 const thumbFile=thumbInput.files[0];
 const allowComments=commentsInput.checked;

 if(!title||!videoFile||!thumbFile){
   errorBox.textContent="Champs requis manquants";
   return;
 }

 try{
   /* 1️⃣ Create short ID */
   const shortRef=push(ref(db,"shorts"));
   const shortId=shortRef.key;
   setProgress(10);

   /* 2️⃣ Upload thumbnail */
   const thumbPath=`shorts-thumbnails/${shortId}.jpg`;
   await supabase.storage.from("thumbnails")
     .upload(thumbPath,thumbFile,{upsert:true});
   setProgress(40);

   /* 3️⃣ Upload video */
   const videoPath=`shorts/${shortId}.mp4`;
   await supabase.storage.from("videos")
     .upload(videoPath,videoFile,{upsert:true});
   setProgress(75);

   const videoURL=`${SUPABASE_URL}/storage/v1/object/public/videos/${videoPath}`;
   const thumbnailURL=`${SUPABASE_URL}/storage/v1/object/public/thumbnails/${thumbPath}`;

   /* 4️⃣ Save metadata */
   await set(shortRef,{
     type:"short",
     title,
     description,
     channelId,
     channelName,
     channelPhotoURL,
     videoURL,
     thumbnailURL,
     allowComments,
     likesEnabled:true,
     shareEnabled:true,
     views:0,
     createdAt:Date.now()
   });

   setProgress(100);
   location.href=`shorts.html?id=${shortId}`;

 }catch(err){
   console.error(err);
   errorBox.textContent=err.message;
 }
};
</script>
</head>

<body>
<div class="container">
<h2>Publier un Short</h2>
<div>Chaîne : <b id="channelNameBox">...</b></div>

<form id="uploadForm">
<input id="titleInput" placeholder="Titre *">
<textarea id="descInput" placeholder="Description"></textarea>

<label>Thumbnail *</label>
<input type="file" id="thumbInput" accept="image/*">

<label>Vidéo verticale *</label>
<input type="file" id="videoInput" accept="video/*">

<label>
 <input type="checkbox" id="commentsInput" checked>
 Autoriser les commentaires
</label>

<button type="submit">Publier</button>

<div class="progress"><div class="bar" id="progressBar"></div></div>
<div class="error" id="error"></div>
</form>
</div>
</body>
</html>
