<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Publier MV – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Font Awesome pour icônes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from
 "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, push, set }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
});

const auth = getAuth(app);
const db = getDatabase(app);

let channelId = null;
let channelName = null;

onAuthStateChanged(auth, async user => {
  if (!user) return location.href="auth.html";

  const userSnap = await get(ref(db,"users/"+user.uid));
  if(!userSnap.exists() || !userSnap.val().channelId){
    location.href="add-channel.html";
    return;
  }

  channelId = userSnap.val().channelId;
  const channelSnap = await get(ref(db,"channels/"+channelId));
  channelName = channelSnap.val().name;
});

const toBase64 = file => new Promise(res=>{
  const r=new FileReader();
  r.onload=()=>res(r.result);
  r.readAsDataURL(file);
});

uploadForm.onsubmit = async e =>{
  e.preventDefault();

  const title=title.value.trim();
  const video=videoFile.files[0];
  const thumb=thumbFile.files[0];

  if(!title||!video||!thumb) return alert("Champs manquants");

  const v64=await toBase64(video);
  const t64=await toBase64(thumb);

  const refVid = push(ref(db,"videos"));
  await set(refVid,{
    title,
    videoBase64:v64,
    thumbnailBase64:t64,
    channelId,
    channelName,
    category:"MV",
    createdAt:Date.now(),
    views:0,
    likes:0,
    allowComments:true
  });

  await set(ref(db,`channels/${channelId}/videos/${refVid.key}`),true);
  location.href="index.html";
};
</script>
<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:#181818;
  color:white;
}

/* HEADER */
header{
  position:fixed; top:0; left:0; right:0; height:56px;
  background:#0f0f0f; display:flex; align-items:center; justify-content:space-between;
  padding:0 16px; z-index:10;
}
header h1{font-size:20px; font-weight:600;}
header button{background:#202020; color:white; border:none; padding:6px 12px; border-radius:12px; cursor:pointer;}

/* CONTENT */
main{margin-top:72px; padding:16px; max-width:600px; margin-left:auto; margin-right:auto;}

form{display:flex; flex-direction:column; gap:16px;}
label{font-weight:600;}
input, textarea{padding:8px; border-radius:10px; border:none; outline:none; width:100%; background:#222; color:white;}
textarea{resize:none; height:100px;}
button.submit-btn{
  background:#ff8800; color:white; border:none; padding:12px; border-radius:20px; font-weight:600; cursor:pointer;
}
button.submit-btn:hover{background:#ffa633;}
</style>
</head>

<body>

<header>
  <h1>Publier un MV</h1>
  <button onclick="location.href='index.html'"><i class="fa-solid fa-arrow-left"></i></button>
</header>

<main>
  <form id="uploadForm">
    <label for="title">Titre</label>
    <input id="title" type="text" placeholder="Titre du MV" required>

    <label for="description">Description</label>
    <textarea id="description" placeholder="Description du MV"></textarea>

    <label for="thumbnail">Thumbnail (image)</label>
    <input id="thumbnail" type="file" accept="image/*" required>

    <label for="video">Vidéo (MP4 depuis la galerie)</label>
    <input id="video" type="file" accept="video/*" required>

    <label>
      <input id="comments" type="checkbox" checked>
      Autoriser les commentaires
    </label>

    <button class="submit-btn" type="submit">Publier</button>
  </form>
</main>

</body>
</html>
