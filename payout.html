<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Payout ‚Äì Paiement cr√©ateur | Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, set, push, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let channelId = null;
let balance = 0;

const balanceElem = document.getElementById("balance");
const payoutForm = document.getElementById("payoutForm");
const eligibilityMsg = document.getElementById("eligibilityMsg");

onAuthStateChanged(auth, async user => {
  if(!user){
    alert("Connectez-vous pour acc√©der aux paiements.");
    location.href="auth.html";
    return;
  }
  currentUser = user;

  // R√©cup√©rer le channel
  const chSnap = await get(ref(db, "userChannels/" + user.uid));
  if (!chSnap.exists()) {
    alert("Cr√©ez une cha√Æne d'abord");
    location.href = "add-channel.html";
    return;
  }
  channelId = chSnap.val();

  // V√©rifier le nombre d'abonn√©s
  const subSnap = await get(ref(db, "subscriptions/" + channelId));
  const subs = subSnap.exists() ? Object.keys(subSnap.val()).length : 0;

  if (subs < 1000) {
    payoutForm.style.display = "none";
    eligibilityMsg.style.display = "block";
  } else {
    payoutForm.style.display = "block";
    eligibilityMsg.style.display = "none";
  }

  // Calculer le solde r√©el depuis les vues
  let totalViews = 0;
  const videosSnap = await get(ref(db, "videos"));
  if(videosSnap.exists()){
    Object.entries(videosSnap.val()).forEach(([id,v])=>{
      if(v.channelId === channelId){
        totalViews += v.views || 0;
      }
    });
  }

  // Conversion vues ‚Üí revenu
  balance = (totalViews / 1000) * 1.3;

  // V√©rifier si la mon√©tisation est activ√©e (taxe de 0,5$/mois)
  const mSnap = await get(ref(db, "monetization/" + channelId));
  if(mSnap.exists() && mSnap.val().enabled){
    balance -= 0.5; // taxe mensuelle
    if(balance < 0) balance = 0;
  }

  balanceElem.innerText = balance.toFixed(2) + " $";

  // Sauvegarder le solde dans Firebase pour historique
  await set(ref(db,"creatorBalances/"+currentUser.uid),{ balance });
});

// Soumettre une demande de payout
payoutForm.addEventListener("submit", async e => {
  e.preventDefault();

  const amount = parseFloat(document.getElementById("amount").value);
  const method = document.getElementById("method").value;
  const info = document.getElementById("info").value.trim();

  if(amount <= 0 || amount > balance){
    alert("Montant invalide.");
    return;
  }
  if(!method || !info){
    alert("Veuillez remplir tous les champs.");
    return;
  }

  // Sauvegarde dans Firebase
  const payoutRef = push(ref(db, "payoutRequests"));
  await set(payoutRef,{
    uid: currentUser.uid,
    channelId,
    amount,
    method,
    info,
    status: "pending",
    createdAt: serverTimestamp()
  });

  balance -= amount;
  if(balance < 0) balance = 0;
  await set(ref(db,"creatorBalances/"+currentUser.uid),{ balance });

  alert("Demande de paiement envoy√©e avec succ√®s ! Vous allez √™tre redirig√© vers WhatsApp pour confirmation.");

  const message = encodeURIComponent(
    `Bonjour Lumio,\n\nJe souhaite recevoir mon paiement de ${amount}$ via ${method}.\nD√©tails: ${info}\n\nMerci.`
  );
  window.open(`https://wa.me/50941040511?text=${message}`, "_blank");
  window.open(`mailto:bjosephbrooks07@gmail.com?subject=Demande de paiement Lumio&body=${message}`, "_blank");

  location.reload();
});
</script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#181818;
  color:white;
  font-family:system-ui;
}
header{
  height:56px;
  background:#0f0f0f;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}
main{
  max-width:600px;
  margin:40px auto;
  padding:20px;
}
.card{
  background:#202020;
  border-radius:14px;
  padding:20px;
  margin-bottom:20px;
}
h3{margin-top:0}
.balance{
  font-size:26px;
  font-weight:700;
  color:#ff8800;
}
input,select{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#2a2a2a;
  color:white;
  margin-bottom:12px;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:20px;
  background:#ff8800;
  font-weight:700;
  cursor:pointer;
}
.notice{
  color:#aaa;
  font-size:14px;
}
#eligibilityMsg{
  display:none;
  background:#331111;
  padding:16px;
  border-radius:14px;
  margin-bottom:20px;
}
</style>
</head>

<body>

<header>
  <h2>Payout Lumio</h2>
  <button onclick="location.href='studio.html'">
    <i class="fa-solid fa-arrow-left"></i>
  </button>
</header>

<main>

<div class="card">
  <h3>üí∞ Solde disponible</h3>
  <div class="balance" id="balance">1 300.24 $</div>
  <p class="notice">Minimum de retrait conseill√© : 150$+</p>
</div>

<div id="eligibilityMsg">
  ‚ùå Vous n'avez pas encore 1000 abonn√©s, impossible de faire un virement tant que vous n'√™tes pas √©ligible.
</div>

<div class="card">
  <h3>üì§ Demander un paiement</h3>

  <form id="payoutForm">
    <input type="number" id="amount" placeholder="Montant √† retirer ($)" step="0.01" required>

    <select id="method" required>
      <option value="">M√©thode de paiement</option>
      <option value="unibank">Unibank</option>
      <option value="songebank">Songebank</option>
      <option value="paypal">Paypal</option>
      <option value="wise">Wise</option>
      <option value="payoneer">Payoneer</option>
    </select>

    <input type="text" id="info" placeholder="Num√©ro de compte, IBAN, email ou wallet..." required>

    <button type="submit">Envoyer la demande</button>
  </form>
</div>

<div class="card">
  <h3>‚ÑπÔ∏è Informations</h3>
  <ul class="notice">
    <li>Les paiements sont calcul√©s automatiquement : 1,3$ par 1000 vues.</li>
    <li>Taxe mon√©tisation : 0,5$/mois.</li>
    <li>Les paiements sont trait√©s manuellement par l‚Äô√©quipe Lumio.</li>
    <li>D√©lai moyen : 24 √† 72 heures.</li>
    <li>Apr√®s soumission, vous serez redirig√© vers WhatsApp et Gmail pour confirmation.</li>
  </ul>
</div>

</main>

</body>
</html>
