<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Retrait – Lumio Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;background:#0f0f0f;color:white;font-family:system-ui}
header{padding:20px;font-size:22px;font-weight:600;text-align:center}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;padding:16px}
.card{background:#1c1c1c;border-radius:12px;padding:16px;margin:16px}
.card span{font-size:12px;color:#aaa}
.card h2{margin:4px 0 0}
button{background:#ff9800;color:black;padding:14px;border:none;border-radius:12px;font-weight:700;cursor:pointer;width:100%}
button:disabled{opacity:0.6;cursor:not-allowed}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border-bottom:1px solid #333;font-size:13px;color:white}
th{color:#aaa}
</style>
</head>

<body>
<header>Retrait – Lumio Studio</header>

<div class="stats">
  <div class="card"><span>Solde disponible</span><h2 id="balance">$0</h2></div>
  <div class="card"><span>Total gagné</span><h2 id="earned">$0</h2></div>
  <div class="card"><span>Total retiré</span><h2 id="withdrawn">$0</h2></div>
</div>

<div class="card">
  <button id="payoutBtn">Demander un retrait</button>
</div>

<div class="card">
  <h3>Historique des demandes</h3>
  <table>
    <thead>
      <tr><th>Date</th><th>Montant</th><th>Statut</th></tr>
    </thead>
    <tbody id="payoutHistory"></tbody>
  </table>
</div>

<script type="module">
import { getDatabase, ref, get, push, set, update, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

async function securePayout(uid, walletRef, amount) {
  const db = getDatabase();

  // 1️⃣ Charger le wallet
  const snap = await get(walletRef);
  if(!snap.exists()) throw new Error("Wallet inexistant");
  const w = snap.val();
  const totalEarned = w.totalEarned || 0;
  const totalWithdrawn = w.totalWithdrawn || 0;

  const available = (totalEarned * 0.85) - totalWithdrawn; // solde réel après commission
  if(amount > available) throw new Error("Solde insuffisant pour cette demande");

  // 2️⃣ Vérifier la dernière demande
  const histRef = ref(db,"payoutRequests/"+uid);
  const histSnap = await get(histRef);
  if(histSnap.exists()){
    const lastReq = Object.values(histSnap.val()).sort((a,b)=>b.date-a.date)[0];
    const now = Date.now();
    if(lastReq && lastReq.date && now - lastReq.date < 5*60*1000){
      throw new Error("Vous devez attendre 5 minutes avant de créer une nouvelle demande");
    }
  }

  // 3️⃣ Créer le log
  const logRef = push(ref(db,"payoutLogs/"+uid));
  await set(logRef,{
    type:"request",
    amount,
    date:serverTimestamp(),
    status:"pending"
  });

  // 4️⃣ Créer la demande
  const reqRef = push(histRef);
  await set(reqRef,{
    amount,
    status:"pending",
    date:serverTimestamp()
  });

  // 5️⃣ Déduire du wallet
  await update(walletRef,{ totalWithdrawn: totalWithdrawn + amount });

  return { success:true, message:"Demande de retrait créée avec succès" };
}

// Exemple d'utilisation sur le bouton
payoutBtn.onclick = async () => {
  payoutBtn.disabled = true;
  payoutBtn.innerText = "Vérification...";

  try{
    const walletRef = ref(db,"wallets/"+currentUser.uid);
    const snap = await get(walletRef);
    const w = snap.exists() ? snap.val() : { totalEarned:0, totalWithdrawn:0 };
    let balance = (w.totalEarned||0)*0.85 - (w.totalWithdrawn||0);
    if(balance < 10) throw new Error("Solde insuffisant, minimum retrait = 10$");

    const res = await securePayout(currentUser.uid, walletRef, balance);
    alert(res.message);
    location.reload();
  }catch(err){
    alert(err.message);
    payoutBtn.disabled = false;
    payoutBtn.innerText = "Demander un retrait";
  }
};
</script>
  
</body>
</html>
