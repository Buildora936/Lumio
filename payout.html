<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Payout â€“ Lumio Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

onAuthStateChanged(auth, async user => {
  if(!user) location.href="auth.html";

  const uid = user.uid;

  const videosSnap = await get(ref(db, "videos"));
  const subsSnap = await get(ref(db, "subscriptions"));
  const monetSnap = await get(ref(db,"monetization/"+uid));

  let totalViews = 0;
  let totalSubs = 0;
  let totalRevenue = 0;

  // AbonnÃ©s
  if(subsSnap.exists() && subsSnap.val()[uid]){
    totalSubs = Object.keys(subsSnap.val()[uid]).length;
  }

  // MonÃ©tisation
  const monetized = monetSnap.exists() && monetSnap.val().enabled && totalSubs >= 1000;

  if(videosSnap.exists()){
    Object.values(videosSnap.val()).forEach(v=>{
      if(v.channelId === uid){
        totalViews += v.views || 0;
      }
    });
  }

  if(monetized){
    totalRevenue = ((totalViews)/1000)*1.3; // 1,3$ / 1000 vues
  }

  document.getElementById("views").innerText = totalViews;
  document.getElementById("subs").innerText = totalSubs;
  document.getElementById("revenue").innerText = "$" + totalRevenue.toFixed(2);

  // Bouton de payout â†’ WhatsApp
  document.getElementById("payoutBtn").onclick = ()=>{
    const msg = encodeURIComponent(`Bonjour, je souhaite retirer mes gains Lumio : $${totalRevenue.toFixed(2)}`);
    window.open(`https://wa.me/NUMERO_WHATSAPP?text=${msg}`, "_blank");
  };
});
</script>

<style>
body{margin:0;background:#0f0f0f;color:white;font-family:system-ui;}
header{padding:20px;font-size:22px;font-weight:600;}
.card{background:#1c1c1c;border-radius:12px;padding:16px;margin:16px;}
button{background:#ff9800;color:black;padding:12px 24px;border:none;border-radius:12px;font-weight:700;cursor:pointer;}
button:hover{opacity:0.9;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;padding:16px;}
.card h2{margin:4px 0 0;}
.card span{font-size:12px;color:#aaa;}
</style>
</head>

<body>

<header>ðŸ’¸ Retrait â€“ Lumio Studio</header>

<div class="stats">
  <div class="card"><span>Total vues</span><h2 id="views">0</h2></div>
  <div class="card"><span>Total abonnÃ©s</span><h2 id="subs">0</h2></div>
  <div class="card"><span>Revenu disponible</span><h2 id="revenue">$0</h2></div>
</div>

<div class="card">
  <button id="payoutBtn">Retirer mes gains </button>
</div>

</body>
</html>
