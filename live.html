<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Live â€“ Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const params = new URLSearchParams(window.location.search);
const liveId = params.get("id");

if(!liveId){
  alert("Live introuvable");
  location.href = "index.html";
}

let currentUser = null;
let liveData = null;

onAuthStateChanged(auth, user=>{
  currentUser = user;
});

/* ðŸ”´ Charger les infos du live */
const liveRef = ref(db, `lives/${liveId}`);
onValue(liveRef, snap=>{
  if(!snap.exists()){
    alert("Ce live n'existe plus");
    location.href = "index.html";
    return;
  }
  liveData = snap.val();

  document.getElementById("title").textContent = liveData.title;
  document.getElementById("channel").textContent = liveData.channelName;
  document.getElementById("viewers").textContent = liveData.viewersCount || 0;

  document.getElementById("videoBox").style.backgroundImage =
    `url('${liveData.thumbnailBase64}')`;
});

/* ðŸ‘ï¸ Ajouter un viewer */
(async ()=>{
  const snap = await get(liveRef);
  if(snap.exists()){
    const count = snap.val().viewersCount || 0;
    update(liveRef,{ viewersCount: count + 1 });
  }
})();

/* ðŸ›‘ Fin du live (seulement pour le propriÃ©taire) */
async function endLive(){
  if(!currentUser){
    alert("Connexion requise");
    return;
  }

  if(currentUser.uid !== liveData.ownerUid){
    alert("Seul le crÃ©ateur peut arrÃªter ce live");
    return;
  }

  await update(liveRef,{
    status:"ended",
    endedAt:Date.now()
  });

  alert("Live terminÃ©");
  location.href = "index.html";
}

window.endLive = endLive;
</script>

<style>
body{
  margin:0;
  background:#181818;
  color:white;
  font-family:system-ui;
}
header{
  height:56px;
  background:#0f0f0f;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}
header h2{margin:0}
main{
  max-width:900px;
  margin:20px auto;
  padding:16px;
}
.video-box{
  width:100%;
  height:360px;
  background:#000;
  border-radius:14px;
  background-size:cover;
  background-position:center;
  position:relative;
}
.live-badge{
  position:absolute;
  top:10px;
  left:10px;
  background:red;
  padding:4px 10px;
  border-radius:6px;
  font-size:12px;
  font-weight:700;
}
.info{
  margin-top:12px;
}
.info h3{
  margin:4px 0;
}
.meta{
  color:#aaa;
  font-size:14px;
}
.actions{
  margin-top:10px;
}
button{
  background:#ff3b3b;
  border:none;
  color:white;
  padding:10px 16px;
  border-radius:20px;
  font-weight:600;
  cursor:pointer;
}
.viewer-count{
  display:flex;
  align-items:center;
  gap:6px;
  color:#ff5555;
  font-weight:600;
}
</style>
</head>

<body>

<header>
  <h2>Lumio Live</h2>
  <button onclick="location.href='index.html'">Accueil</button>
</header>

<main>

  <div class="video-box" id="videoBox">
    <div class="live-badge">ðŸ”´ LIVE</div>
  </div>

  <div class="info">
    <h3 id="title">Chargement...</h3>
    <div class="meta">
      <span id="channel">...</span>
    </div>
  </div>

  <div class="actions">
    <div class="viewer-count">
      <i class="fa-solid fa-eye"></i>
      <span id="viewers">0</span> spectateurs
    </div>
    <br>
    <button onclick="endLive()">ðŸ›‘ ArrÃªter le Live</button>
  </div>

</main>

</body>
</html>
