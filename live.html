<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lumio Live</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{
  margin:0;
  background:#0f0f0f;
  font-family:system-ui;
  color:white;
}

header{
  height:56px;
  background:#181818;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}

header h2{
  margin:0;
  font-size:18px;
}

.main{
  display:flex;
  gap:16px;
  padding:16px;
  max-width:1400px;
  margin:auto;
}

.video-area{
  flex:2;
}

video{
  width:100%;
  height:70vh;
  background:black;
  border-radius:12px;
}

.live-info{
  margin-top:10px;
  font-size:14px;
  color:#aaa;
}

.chat{
  flex:1;
  background:#181818;
  border-radius:12px;
  display:flex;
  flex-direction:column;
  height:75vh;
}

.chat-messages{
  flex:1;
  overflow-y:auto;
  padding:12px;
}

.msg{
  margin-bottom:10px;
  font-size:14px;
}

.msg span{
  font-weight:600;
}

.chat-input{
  display:flex;
  padding:10px;
  gap:8px;
  border-top:1px solid #333;
}

.chat-input input{
  flex:1;
  padding:10px;
  border:none;
  border-radius:20px;
  background:#222;
  color:white;
}

.chat-input button{
  background:#ff0000;
  border:none;
  padding:10px 14px;
  border-radius:20px;
  color:white;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h2 id="liveTitle">ðŸ”´ Live</h2>
  <div id="viewerCount">0 spectateurs</div>
</header>

<div class="main">

  <div class="video-area">
    <video id="remoteVideo" autoplay playsinline></video>

    <div class="live-info">
      ChaÃ®ne : <span id="channelName"></span>
    </div>
  </div>

  <div class="chat">
    <div class="chat-messages" id="messages"></div>

    <div class="chat-input">
      <input id="msgInput" placeholder="Ã‰crire un message...">
      <button id="sendBtn">
        <i class="fa fa-paper-plane"></i>
      </button>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from
 "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase,ref,set,onValue,push,remove,get }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
 authDomain:"lumio-6efed.firebaseapp.com",
 databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
 projectId:"lumio-6efed"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);

const params=new URLSearchParams(location.search);
const liveId=params.get("id");
if(!liveId) location.href="index.html";

let currentUser=null;
let viewerRef=null;

const remoteVideo=document.getElementById("remoteVideo");

/* ================= AUTH ================= */

onAuthStateChanged(auth,async u=>{
 currentUser=u;

 // VÃ©rifie si banni
 if(u){
   const banSnap=await get(ref(db,`liveBans/${liveId}/${u.uid}`));
   if(banSnap.exists()){
     alert("Vous Ãªtes banni de ce live.");
     location.href="index.html";
     return;
   }
 }

 // Ajouter viewer
 viewerRef=ref(db,`liveViewers/${liveId}/${u?.uid||("guest_"+Date.now())}`);
 await set(viewerRef,true);

 window.addEventListener("beforeunload",()=>{
   remove(viewerRef);
 });
});

/* ================= LIVE DATA ================= */

onValue(ref(db,`lives/${liveId}`),snap=>{
 if(!snap.exists()){
   alert("Live introuvable");
   location.href="index.html";
   return;
 }

 const l=snap.val();
 if(l.status==="ended"){
   alert("Live terminÃ©");
   location.href="index.html";
   return;
 }

 document.getElementById("liveTitle").textContent="ðŸ”´ "+l.title;
 document.getElementById("channelName").textContent=l.channelName;
});

/* ================= VIEWERS ================= */

onValue(ref(db,`liveViewers/${liveId}`),snap=>{
 const viewers=snap.val()||{};
 document.getElementById("viewerCount").textContent=
   Object.keys(viewers).length+" spectateurs";
});

/* ================= WEBRTC ================= */

const iceServers={
 iceServers:[
   {urls:"stun:stun.l.google.com:19302"}
 ]
};

const pc=new RTCPeerConnection(iceServers);

pc.ontrack=e=>{
 remoteVideo.srcObject=e.streams[0];
};

pc.onicecandidate=e=>{
 if(e.candidate){
   push(ref(db,`liveSignals/${liveId}/viewerIce`),
     e.candidate.toJSON());
 }
};

// ðŸ”¹ Lire offer du crÃ©ateur
onValue(ref(db,`liveSignals/${liveId}/offers`),async snap=>{
 snap.forEach(async child=>{
   const offer=child.val();
   if(!pc.currentRemoteDescription){
     await pc.setRemoteDescription(new RTCSessionDescription(offer));
     const answer=await pc.createAnswer();
     await pc.setLocalDescription(answer);
     await set(ref(db,`liveSignals/${liveId}/answers/${auth.currentUser?.uid||"guest"}`),answer);
   }
 });
});

/* ================= CHAT ================= */

onValue(ref(db,`liveChat/${liveId}`),snap=>{
 messages.innerHTML="";
 snap.forEach(m=>{
   const div=document.createElement("div");
   div.className="msg";
   div.innerHTML=`<span>${m.val().user}</span>: ${m.val().text}`;
   messages.appendChild(div);
 });
 messages.scrollTop=messages.scrollHeight;
});

sendBtn.onclick=async()=>{
 const text=msgInput.value.trim();
 if(!text) return;

 msgInput.value="";

 await push(ref(db,`liveChat/${liveId}`),{
   user:currentUser?.displayName||"InvitÃ©",
   text,
   uid:currentUser?.uid||null,
   createdAt:Date.now()
 });
};
</script>

</body>
</html>
