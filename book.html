<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Lecteur</title>

<style>
body{margin:0;background:#202020;font-family:serif;overflow:hidden}
.reader{position:absolute;inset:0;display:flex;justify-content:center;align-items:center}
.page{
 width:90%;max-width:900px;height:90%;
 background:#fdf6e3;border-radius:14px;
 box-shadow:0 20px 60px rgba(0,0,0,.6);
 padding:50px;position:relative;animation:pop .25s ease
}
@keyframes pop{from{transform:scale(.97)}to{transform:scale(1)}}

.text{height:100%;overflow:hidden;line-height:1.9}
.counter{position:absolute;bottom:14px;right:20px;font-size:14px;color:#555}

.bar{
 position:fixed;bottom:20px;left:50%;
 transform:translateX(-50%);
 background:#111;border-radius:40px;padding:10px 14px;
 display:flex;gap:10px;z-index:9
}
.bar button{
 background:#333;border:none;color:white;
 padding:10px 14px;border-radius:30px;cursor:pointer
}

.dark{background:#111;color:#ddd}
.dark .page{background:#111;color:#ddd}
.sepia .page{background:#f4ecd8}
</style>
</head>
<body>

<div class="reader" id="reader"></div>

<div class="bar">
<button id="prev">◀</button>
<button id="next">▶</button>
<button id="fontUp">A+</button>
<button id="fontDown">A-</button>
<button id="themeBtn">☾</button>
<button id="mark">Highlight</button>
<button id="note">Note</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase,ref,get,set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const app=initializeApp({
 apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
 authDomain:"lumio-6efed.firebaseapp.com",
 databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
 projectId:"lumio-6efed"
});

const db=getDatabase(app);
const auth=getAuth(app);

const id=new URLSearchParams(location.search).get("id");
if(!id) location.href="books.html";

const snap=await get(ref(db,"books/"+id));
if(!snap.exists()) throw alert("Livre introuvable");

const book=snap.val();
const container=document.getElementById("reader");

let font=parseInt(localStorage.getItem("font"))||22;
let pages=[];
let index=parseInt(localStorage.getItem("read_"+id))||0;
let theme=localStorage.getItem("theme")||"";

/* PAGINATION HTML SAFE */
function paginate(html){
 const tmp=document.createElement("div");
 tmp.innerHTML=html;

 const words=tmp.innerHTML.split(" ");
 let buf="";
 pages=[];

 const meas=document.createElement("div");
 meas.style.cssText=`
 position:absolute;
 visibility:hidden;
 width:800px;
 height:1200px;
 overflow:hidden;
 font-size:${font}px;
 line-height:1.9;
 `;
 document.body.appendChild(meas);

 for(const w of words){
  meas.innerHTML=buf+" "+w;
  if(meas.scrollHeight>meas.clientHeight){
    pages.push(buf);
    buf=w;
  }else buf+=" "+w;
 }
 pages.push(buf);
 meas.remove();
}

paginate(book.content||"Livre vide");

/* RENDER */
function render(){
 container.innerHTML="";
 const p=document.createElement("div");
 p.className="page";

 p.innerHTML=`
 <div class="text" style="font-size:${font}px">${pages[index]}</div>
 <div class="counter">${index+1}/${pages.length}</div>
 `;
 container.appendChild(p);

 localStorage.setItem("read_"+id,index);
}
render();

/* SAVE PROGRESS THROTTLE */
let saveTimeout=null;
function saveProgress(){
 if(!auth.currentUser) return;
 clearTimeout(saveTimeout);
 saveTimeout=setTimeout(()=>{
  set(ref(db,"progress/"+auth.currentUser.uid+"/"+id),index);
 },1000);
}

/* NAV */
next.onclick=()=>{ if(index<pages.length-1){index++;render();saveProgress();}};
prev.onclick=()=>{ if(index>0){index--;render();saveProgress();}};

/* KEYS */
document.addEventListener("keydown",e=>{
 if(e.key==="ArrowRight") next.click();
 if(e.key==="ArrowLeft") prev.click();
});

/* SWIPE */
let sx=0;
container.addEventListener("touchstart",e=>sx=e.touches[0].clientX);
container.addEventListener("touchend",e=>{
 let dx=e.changedTouches[0].clientX-sx;
 if(Math.abs(dx)<50)return;
 dx<0?next.click():prev.click();
});

/* FONT */
fontUp.onclick=()=>{
 font+=2;
 localStorage.setItem("font",font);
 paginate(book.content);
 render();
};
fontDown.onclick=()=>{
 font=Math.max(14,font-2);
 localStorage.setItem("font",font);
 paginate(book.content);
 render();
};

/* THEME */
themeBtn.onclick=()=>{
 document.body.classList.toggle("dark");
 localStorage.setItem("theme",
 document.body.classList.contains("dark")?"dark":"");
};

if(theme==="dark") document.body.classList.add("dark");

/* NOTE */
note.onclick=()=>{
 const t=prompt("Note page "+(index+1));
 if(!t)return;
 localStorage.setItem("note_"+id+"_"+index,t);
};
</script>
 
</body>
</html>
