<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Lecteur</title>

<style>
body{margin:0;background:#202020;font-family:serif;overflow:hidden}
.reader{position:absolute;inset:0;display:flex;justify-content:center;align-items:center}
.page{
 width:90%;max-width:900px;height:90%;
 background:#fdf6e3;border-radius:14px;
 box-shadow:0 20px 60px rgba(0,0,0,.6);
 padding:50px;position:relative;animation:pop .25s ease
}
@keyframes pop{from{transform:scale(.97)}to{transform:scale(1)}}

.text{height:100%;overflow:hidden;line-height:1.9}
.counter{position:absolute;bottom:14px;right:20px;font-size:14px;color:#555}

.bar{
 position:fixed;bottom:20px;left:50%;
 transform:translateX(-50%);
 background:#111;border-radius:40px;padding:10px 14px;
 display:flex;gap:10px;z-index:9
}
.bar button{
 background:#333;border:none;color:white;
 padding:10px 14px;border-radius:30px;cursor:pointer
}

.dark{background:#111;color:#ddd}
.dark .page{background:#111;color:#ddd}
.sepia .page{background:#f4ecd8}
</style>
</head>
<body>

<div class="reader" id="reader"></div>

<div class="bar">
<button id="prev">◀</button>
<button id="next">▶</button>
<button id="fontUp">A+</button>
<button id="fontDown">A-</button>
<button id="themeBtn">☾</button>
<button id="mark">Highlight</button>
<button id="note">Note</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase,ref,get,set,update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const app=initializeApp({
 apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
 authDomain:"lumio-6efed.firebaseapp.com",
 databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
 projectId:"lumio-6efed"
});

const db=getDatabase(app);
const auth=getAuth(app);
const container=document.getElementById("reader");

const id=new URLSearchParams(location.search).get("id");
if(!id) location.href="books.html";

let book;
let pages=[];
let index=0;
let font=22;
let theme=0;
let user;

/* AUTH + ACCESS CHECK */
onAuthStateChanged(auth, async u=>{
 if(!u) return location.href="auth.html";
 user=u;

 const owned=await get(ref(db,"purchases/"+u.uid+"/"+id));
 if(!owned.exists()){
  document.body.innerHTML="<h2 style='color:white;text-align:center;margin-top:40vh'>Livre non acheté</h2>";
  return;
 }

 loadBook();
});

/* LOAD BOOK */
async function loadBook(){
 const snap=await get(ref(db,"books/"+id));
 if(!snap.exists()){
  container.innerHTML="<h2>Livre introuvable</h2>";
  return;
 }
 book=snap.val();

 paginate(stripHTML(book.content||"Livre vide"));

 const saved=localStorage.getItem("read_"+id);
 if(saved) index=parseInt(saved);

 render();
}

/* REMOVE HTML TAGS */
function stripHTML(html){
 const div=document.createElement("div");
 div.innerHTML=html;
 return div.innerText;
}

/* PAGINATION ENGINE */
function paginate(text){
 const measure=document.createElement("div");
 measure.style.cssText=`
 position:absolute;
 visibility:hidden;
 width:700px;
 height:900px;
 line-height:1.9;
 font-size:${font}px;
 `;
 document.body.appendChild(measure);

 pages=[];
 let words=text.split(" ");
 let buf="";

 for(const w of words){
  measure.innerText=buf+" "+w;
  if(measure.scrollHeight>measure.clientHeight){
   pages.push(buf);
   buf=w;
  }else buf+=" "+w;
 }
 pages.push(buf);
 measure.remove();
}

/* RENDER */
function render(){
 container.innerHTML="";
 const p=document.createElement("div");
 p.className="page";

 p.innerHTML=`
 <div class="text" style="font-size:${font}px">${pages[index]}</div>
 <div class="counter">${index+1}/${pages.length}</div>
 `;
 container.appendChild(p);

 localStorage.setItem("read_"+id,index);

 if(user)
  update(ref(db,"progress/"+user.uid),{[id]:index});
}

/* NAV */
next.onclick=()=>{if(index<pages.length-1){index++;render();}}
prev.onclick=()=>{if(index>0){index--;render();}}

document.addEventListener("keydown",e=>{
 if(e.key==="ArrowRight") next.click();
 if(e.key==="ArrowLeft") prev.click();
});

/* SWIPE */
let sx=0;
container.addEventListener("touchstart",e=>sx=e.touches[0].clientX);
container.addEventListener("touchend",e=>{
 let dx=e.changedTouches[0].clientX-sx;
 if(Math.abs(dx)<50) return;
 dx<0?next.click():prev.click();
});

/* FONT */
fontUp.onclick=()=>{font+=2;paginate(stripHTML(book.content));render();}
fontDown.onclick=()=>{
 if(font<=14) return;
 font-=2;
 paginate(stripHTML(book.content));
 render();
};

/* THEME */
themeBtn.onclick=()=>{
 theme=(theme+1)%3;
 document.body.classList.remove("dark","sepia");
 if(theme===1) document.body.classList.add("dark");
 if(theme===2) document.body.classList.add("sepia");
};

/* HIGHLIGHT SAVE FIREBASE */
mark.onclick=async()=>{
 const sel=window.getSelection().toString();
 if(!sel) return;
 await push(ref(db,"highlights/"+user.uid+"/"+id+"/"+index),{
  text:sel,
  date:Date.now()
 });
 alert("Surligné");
};

/* NOTE SAVE FIREBASE */
note.onclick=async()=>{
 const t=prompt("Note page "+(index+1));
 if(!t) return;
 await push(ref(db,"notes/"+user.uid+"/"+id+"/"+index),{
  text:t,
  date:Date.now()
 });
 alert("Note enregistrée");
};

/* AUTO DARK */
if(window.matchMedia("(prefers-color-scheme: dark)").matches)
 document.body.classList.add("dark");

</script>
</body>
</html>
