<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lecteur</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<style>
body{
 margin:0;
 background:#202020;
 font-family:serif;
 display:flex;
 flex-direction:column;
 align-items:center;
 transition:.3s;
}

.topbar{
 width:100%;
 padding:12px;
 text-align:center;
 color:white;
 font-weight:600;
}

.controls{
 display:flex;
 gap:8px;
 margin:10px;
 flex-wrap:wrap;
 justify-content:center;
}
.controls button{
 border:none;
 padding:8px 14px;
 border-radius:8px;
 cursor:pointer;
 background:#333;
 color:white;
}

.book{
 width:92%;
 max-width:750px;
 height:75vh;
 background:#fdf6e3;
 border-radius:12px;
 box-shadow:0 10px 40px rgba(0,0,0,.6);
 padding:40px;
 position:relative;
 overflow:hidden;
 transition:.3s;
}

.page{
 height:100%;
 overflow:auto;
 font-size:18px;
 line-height:1.8;
 transition:.2s;
}

.counter{
 position:absolute;
 bottom:12px;
 right:18px;
 font-size:14px;
 color:#666;
}

.nav{
 display:flex;
 justify-content:space-between;
 width:92%;
 max-width:750px;
 margin-top:10px;
}

.nav button{
 padding:10px 18px;
 border:none;
 border-radius:8px;
 background:#2c2c2c;
 color:white;
 cursor:pointer;
}

.flip{animation:flip .35s}
@keyframes flip{
 from{transform:rotateY(90deg);opacity:.3}
 to{transform:rotateY(0);opacity:1}
}

/* mode nuit */
.night body{background:#111}
.night .book{background:#111;color:#ddd}
.night .counter{color:#aaa}
</style>
</head>
<body>

<div class="topbar" id="title">Livre</div>

<div class="controls">
<button id="night">üåô Mode nuit</button>
<button id="plus">A+</button>
<button id="minus">A-</button>
<button id="bookmark">üîñ Signet</button>
<button id="resume">‚Ü∫ Reprendre</button>
</div>

<div class="book" id="book">
 <div class="page" id="page"></div>
 <div class="counter" id="counter"></div>
</div>

<div class="nav">
<button id="prev">‚Üê</button>
<button id="next">‚Üí</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase,ref,get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app=initializeApp({
 apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
 authDomain:"lumio-6efed.firebaseapp.com",
 databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
 projectId:"lumio-6efed"
});
const db=getDatabase(app);

const id=new URLSearchParams(location.search).get("id");
const snap=await get(ref(db,"books/"+id));

const pageEl=document.getElementById("page");
const counter=document.getElementById("counter");
const title=document.getElementById("title");

let pages=[];
let index=0;
let size=18;

if(!snap.exists()){
 pageEl.innerHTML="Livre introuvable";
 throw "";
}

const book=snap.val();
pages=book.pages||["Vide"];
title.innerText=book.title||"Livre";

/* restore last page */
const saved=localStorage.getItem("read_"+id);
if(saved) index=parseInt(saved);

/* render */
function render(){
 pageEl.classList.remove("flip");
 void pageEl.offsetWidth;
 pageEl.classList.add("flip");

 pageEl.innerHTML=pages[index];
 counter.innerText=`${index+1}/${pages.length}`;

 prev.disabled=index===0;
 next.disabled=index===pages.length-1;

 localStorage.setItem("read_"+id,index);
}
render();

/* nav */
prev.onclick=()=>{if(index>0){index--;render();}}
next.onclick=()=>{if(index<pages.length-1){index++;render();}}

/* swipe */
let startX=0;
book.addEventListener("touchstart",e=>startX=e.touches[0].clientX);
book.addEventListener("touchend",e=>{
 let diff=e.changedTouches[0].clientX-startX;
 if(Math.abs(diff)<40)return;
 diff<0?next.click():prev.click();
});

/* clavier */
document.addEventListener("keydown",e=>{
 if(e.key==="ArrowRight") next.click();
 if(e.key==="ArrowLeft") prev.click();
});

/* zoom texte */
plus.onclick=()=>{size+=2;pageEl.style.fontSize=size+"px";}
minus.onclick=()=>{size=Math.max(12,size-2);pageEl.style.fontSize=size+"px";}

/* nuit */
night.onclick=()=>document.documentElement.classList.toggle("night");

/* signet */
bookmark.onclick=()=>{
 localStorage.setItem("bookmark_"+id,index);
 alert("Signet ajout√© page "+(index+1));
};

/* reprendre */
resume.onclick=()=>{
 const b=localStorage.getItem("bookmark_"+id);
 if(b!==null){index=parseInt(b);render();}
};
</script>
</body>
</html>
