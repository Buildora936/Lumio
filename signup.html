<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Inscription – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* Utils */
function toBase64(file){
  return new Promise((res, rej)=>{
    const reader = new FileReader();
    reader.onload = ()=>res(reader.result);
    reader.onerror = e=>rej(e);
    reader.readAsDataURL(file);
  });
}

function getAge(date){
  const today = new Date();
  const birth = new Date(date);
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if(m<0 || (m===0 && today.getDate()<birth.getDate())) age--;
  return age;
}

/* DOM */
const form = document.getElementById("signupForm");
const errorBox = document.getElementById("error");
const createChannelCheckbox = document.getElementById("createChannel");
const channelFields = document.getElementById("channelFields");
const progressBar = document.getElementById("progressBar");

/* Toggle channel fields */
createChannelCheckbox.addEventListener("change", ()=>{
  channelFields.style.display = createChannelCheckbox.checked ? "block" : "none";
});

/* Submit */
form.onsubmit = async (e)=>{
  e.preventDefault();
  errorBox.textContent = "";

  // Compte
  const email = emailInput.value.trim();
  const password = passwordInput.value;
  const confirm = confirmInput.value;
  const username = usernameInput.value.trim().toLowerCase();
  const birthdate = birthInput.value;
  const country = countryInput.value;
  const language = languageInput.value;
  const photo = photoInput.files[0];

  if(password !== confirm) return errorBox.textContent = "Mots de passe différents";
  if(password.length < 8) return errorBox.textContent = "Mot de passe trop court";
  if(!birthdate) return errorBox.textContent = "Date de naissance obligatoire";
  if(!photo) return errorBox.textContent = "Photo obligatoire";

  const age = getAge(birthdate);
  const isAdult = age >= 18;

  try{
    // Vérifier username unique
    const snap = await get(ref(db, "usernames/" + username));
    if(snap.exists()) return errorBox.textContent = "Nom d’utilisateur déjà pris";

    // Photo Base64
    const photoBase64 = await toBase64(photo);

    // Création utilisateur
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const uid = cred.user.uid;

    // Mise en base utilisateur
    await set(ref(db, "users/" + uid), {
      email,
      username,
      birthdate,
      age,
      adult: isAdult,
      monetizationEligible: isAdult,
      country,
      language,
      photoURL: photoBase64,
      role: "user",
      createdAt: Date.now()
    });

    await set(ref(db, "usernames/" + username), uid);

    // Progression étape 1 : compte créé
    progressBar.style.width = "33%";

    // Si création chaîne
    if(createChannelCheckbox.checked){
      const channelName = channelNameInput.value.trim();
      const channelDesc = channelDescInput.value.trim();
      const channelPhoto = channelPhotoInput.files[0];
      const channelBanner = channelBannerInput.files[0];

      if(!channelName || !channelDesc || !channelPhoto) 
        return errorBox.textContent = "Nom, description et photo de chaîne obligatoires";

      const channelPhotoBase64 = await toBase64(channelPhoto);
      const channelBannerBase64 = channelBanner ? await toBase64(channelBanner) : "";

      // Création channelId automatique
      const newChannelRef = push(ref(db, "channels/"));
      const channelId = newChannelRef.key;

      await set(newChannelRef, {
        name: channelName,
        description: channelDesc,
        owner: uid,
        photoURL: channelPhotoBase64,
        bannerURL: channelBannerBase64 || "",
        language,
        category: categoryInput.value || "Divers",
        visibility: "public",
        monetization: isAdult,
        commentsEnabled: true,
        mvEnabled: true,
        createdAt: Date.now()
      });

      // Progression étape 2 : chaîne créée
      progressBar.style.width = "66%";

      // Ajouter channelId à l’utilisateur
      await set(ref(db, `users/${uid}/channelId`), channelId);

      // Progression finale
      progressBar.style.width = "100%";

      // Redirection vers la chaîne
      location.href = `channel.html?id=${channelId}`;
    } else {
      // Pas de chaîne
      progressBar.style.width = "100%";
      location.href = "index.html";
    }

  } catch(err){
    console.error(err);
    errorBox.textContent = err.message;
  }
};
</script>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:white;}
.container{max-width:420px;margin:40px auto;padding:20px;}
input,select,button{width:100%;margin:8px 0;padding:12px;border-radius:10px;border:none;background:#1f1f1f;color:white;}
button{background:white;color:black;font-weight:700;cursor:pointer;}
.error{color:#ff5555;text-align:center;font-size:14px;}
label{display:block;margin-top:10px;font-weight:600;}
#channelFields{display:none;}
.progress-container{width:100%;height:6px;background:#333;border-radius:3px;margin-bottom:20px;}
.progress-bar{width:0%;height:100%;background:#4caf50;border-radius:3px;transition:0.3s;}
</style>
</head>

<body>
<div class="container">
<h2>Créer un compte Lumio</h2>

<div class="progress-container">
  <div id="progressBar" class="progress-bar"></div>
</div>

<form id="signupForm">

<input id="emailInput" type="email" placeholder="Email" required>
<input id="passwordInput" type="password" placeholder="Mot de passe" required>
<input id="confirmInput" type="password" placeholder="Confirmer mot de passe" required>
<input id="usernameInput" placeholder="Nom d’utilisateur public" required>

<label>Date de naissance</label>
<input id="birthInput" type="date" required>

<select id="countryInput" required>
  <option value="">Pays</option>
  <option value="HT">Haïti</option>
  <option value="FR">France</option>
  <option value="CA">Canada</option>
</select>

<select id="languageInput">
  <option value="fr">Français</option>
  <option value="en">English</option>
</select>

<label>Photo de profil</label>
<input id="photoInput" type="file" accept="image/*" required>

<label><input type="checkbox" id="createChannel"> Créer une chaîne maintenant</label>

<div id="channelFields">
  <input id="channelNameInput" placeholder="Nom de la chaîne" required>
  <textarea id="channelDescInput" placeholder="Description de la chaîne" required style="height:60px;"></textarea>
  <label>Photo de profil de la chaîne</label>
  <input id="channelPhotoInput" type="file" accept="image/*" required>
  <label>Bannière de la chaîne (optionnelle)</label>
  <input id="channelBannerInput" type="file" accept="image/*">
  <select id="categoryInput">
    <option value="Musique">Musique</option>
    <option value="Gaming">Gaming</option>
    <option value="Éducation">Éducation</option>
    <option value="Divers">Divers</option>
  </select>
</div>

<div class="error" id="error"></div>

<button type="submit">Créer le compte</button>
</form>
</div>
</body>
</html>
