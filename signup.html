<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Cr√©er un compte ‚Äì Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

function toBase64(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = err=>rej(err);
    r.readAsDataURL(file);
  });
}

function isTempEmail(email){
  return /(mailinator|tempmail|10minutemail|guerrillamail)/i.test(email);
}

const form = document.getElementById("signupForm");
const errorBox = document.getElementById("error");
const createChannelBox = document.getElementById("createChannelBox");
const channelFields = document.getElementById("channelFields");

createChannelBox.onchange = () => {
  channelFields.style.display = createChannelBox.checked ? "block" : "none";
};

form.onsubmit = async e => {
  e.preventDefault();
  errorBox.textContent = "";

  const email = emailInput.value.trim();
  const password = passwordInput.value;
  const confirm = confirmInput.value;
  const username = usernameInput.value.trim().toLowerCase();
  const country = countryInput.value;
  const language = languageInput.value;
  const bio = bioInput.value;
  const photo = photoInput.files[0];

  if(password !== confirm) return errorBox.textContent = "Mots de passe diff√©rents";
  if(password.length < 8) return errorBox.textContent = "Mot de passe trop court";
  if(isTempEmail(email)) return errorBox.textContent = "Email temporaire refus√©";
  if(!photo) return errorBox.textContent = "Photo obligatoire";

  const usernameSnap = await get(ref(db, "usernames/" + username));
  if(usernameSnap.exists()) return errorBox.textContent = "Nom d√©j√† utilis√©";

  try {
    const photoBase64 = await toBase64(photo);
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const uid = cred.user.uid;

    await set(ref(db, "users/" + uid), {
      email,
      username,
      country,
      language,
      bio,
      photoURL: photoBase64,
      role: "user",
      createdAt: Date.now()
    });

    await set(ref(db, "usernames/" + username), uid);

    /* üî• Cr√©ation de la cha√Æne si coch√©e */
    if(createChannelBox.checked){
      const channelName = channelNameInput.value.trim();
      const channelDesc = channelDescInput.value.trim();
      const avatarFile = channelAvatarInput.files[0];
      const bannerFile = channelBannerInput.files[0];

      if(!channelName || !avatarFile || !bannerFile){
        return errorBox.textContent = "Infos de cha√Æne incompl√®tes";
      }

      const avatarBase64 = await toBase64(avatarFile);
      const bannerBase64 = await toBase64(bannerFile);

      const channelRef = push(ref(db, "channels"));
      const channelId = channelRef.key;

      await set(channelRef, {
        id: channelId,
        owner: uid,
        name: channelName,
        description: channelDesc,
        avatar: avatarBase64,
        banner: bannerBase64,
        subscribers: 0,
        monetization: false,
        createdAt: Date.now()
      });

      await set(ref(db, "userChannels/" + uid), channelId);
      await set(ref(db, "videosByChannel/" + channelId), {});
      await set(ref(db, "subscriptions/" + channelId), {});
      await set(ref(db, "notifications/" + channelId), {});
      await set(ref(db, "analytics/" + channelId), {});

      alert("üéâ Compte + Cha√Æne cr√©√©s avec succ√®s !");
      location.href = "channel.html?id=" + channelId;
    } else {
      alert("üéâ Compte cr√©√© avec succ√®s !");
      location.href = "index.html";
    }

  } catch(err){
    console.error(err);
    errorBox.textContent = err.message;
  }
};
</script>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:white}
.container{max-width:420px;margin:40px auto;padding:20px}
input,select,textarea,button{
  width:100%;margin:8px 0;padding:12px;
  border-radius:10px;border:none;background:#1f1f1f;color:white
}
button{background:white;color:black;font-weight:600}
.error{color:#ff5555;font-size:14px}
.channel-box{background:#1b1b1b;padding:12px;border-radius:10px}
</style>
</head>

<body>
<div class="container">
<h2>Cr√©er un compte Lumio</h2>

<form id="signupForm">
<input id="emailInput" type="email" placeholder="Email" required>
<input id="passwordInput" type="password" placeholder="Mot de passe" required>
<input id="confirmInput" type="password" placeholder="Confirmer mot de passe" required>

<input id="usernameInput" placeholder="Nom d‚Äôutilisateur public" required>

<select id="countryInput" required>
<option value="">Pays</option>
<option value="HT">Ha√Øti</option>
<option value="FR">France</option>
<option value="CA">Canada</option>
</select>

<select id="languageInput">
<option value="fr">Fran√ßais</option>
<option value="en">English</option>
</select>

<input id="photoInput" type="file" accept="image/*" required>
<textarea id="bioInput" placeholder="Bio"></textarea>

<label>
  <input type="checkbox" id="createChannelBox">
  Cr√©er une cha√Æne maintenant
</label>

<div id="channelFields" class="channel-box" style="display:none;">
  <input id="channelNameInput" placeholder="Nom de la cha√Æne">
  <textarea id="channelDescInput" placeholder="Description de la cha√Æne"></textarea>
  <label>Avatar cha√Æne</label>
  <input type="file" id="channelAvatarInput" accept="image/*">
  <label>Banni√®re cha√Æne</label>
  <input type="file" id="channelBannerInput" accept="image/*">
</div>

<div class="error" id="error"></div>
<button type="submit">Cr√©er le compte</button>
</form>
</div>
</body>
</html>
