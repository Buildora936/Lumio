<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Inscription – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, get, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* Base64 photo */
function toBase64(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = e=>rej(e);
    r.readAsDataURL(file);
  });
}

/* Calcul âge */
function getAge(date){
  const today = new Date();
  const birth = new Date(date);
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

/* Signup */
const form = document.getElementById("signupForm");
const errorBox = document.getElementById("error");
const channelCheckbox = document.getElementById("createChannelCheckbox");
const channelForm = document.getElementById("channelForm");

channelCheckbox.addEventListener("change", ()=>{
  channelForm.style.display = channelCheckbox.checked ? "block" : "none";
});

form.onsubmit = async (e)=>{
  e.preventDefault();
  errorBox.textContent = "";

  const email = emailInput.value.trim();
  const password = passwordInput.value;
  const confirm = confirmInput.value;
  const username = usernameInput.value.trim().toLowerCase();
  const birthdate = birthInput.value;
  const country = countryInput.value;
  const language = languageInput.value;
  const photo = photoInput.files[0];

  if(password !== confirm) return errorBox.textContent = "Mots de passe différents";
  if(password.length < 8) return errorBox.textContent = "Mot de passe trop court";
  if(!birthdate) return errorBox.textContent = "Date de naissance obligatoire";
  if(!photo) return errorBox.textContent = "Photo obligatoire";

  const age = getAge(birthdate);
  const isAdult = age >= 18;

  try{
    // Vérifier username unique
    const snap = await get(ref(db, "usernames/" + username));
    if(snap.exists()) return errorBox.textContent = "Nom d’utilisateur déjà pris";

    const photoBase64 = await toBase64(photo);
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const uid = cred.user.uid;

    // Création structure utilisateur
    await set(ref(db, "users/" + uid), {
      email,
      username,
      birthdate,
      age,
      adult: isAdult,
      monetizationEligible: isAdult,
      country,
      language,
      photoURL: photoBase64,
      role: "user",
      createdAt: Date.now()
    });

    await set(ref(db, "usernames/" + username), uid);

    // Si la case "Créer une chaîne" est cochée
    if(channelCheckbox.checked){
      const channelName = channelNameInput.value.trim();
      const channelDesc = channelDescInput.value.trim() || "";
      if(!channelName) return errorBox.textContent = "Nom de la chaîne obligatoire";

      // Création ID unique pour la chaîne
      const newChannelRef = push(ref(db, "channels"));
      await set(newChannelRef, {
        ownerId: uid,
        name: channelName,
        description: channelDesc,
        thumbnail: "", // Par défaut
        banner: "",
        language,
        subscribers: 0,
        videos: {},
        createdAt: Date.now()
      });

      const channelId = newChannelRef.key;

      // Redirection vers la chaîne
      location.href = `channel.html?id=${channelId}`;
      return;
    }

    // Sinon redirection normale
    alert(
      isAdult 
      ? "Compte créé. Vous pourrez monétiser plus tard." 
      : "Compte créé. Vous pouvez publier mais pas gagner d’argent."
    );
    location.href = "index.html";

  }catch(err){
    console.error(err);
    errorBox.textContent = err.message;
  }
};
</script>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#0f0f0f;
  color:white;
}
.container{
  max-width:420px;
  margin:40px auto;
  padding:20px;
}
input,select,button,textarea{
  width:100%;
  margin:8px 0;
  padding:12px;
  border-radius:10px;
  border:none;
  background:#1f1f1f;
  color:white;
}
button{
  background:white;
  color:black;
  font-weight:700;
  cursor:pointer;
}
.error{
  color:#ff5555;
  text-align:center;
  font-size:14px;
}
#channelForm{
  display:none;
  margin-top:16px;
  border-top:1px solid #333;
  padding-top:16px;
}
</style>
</head>

<body>
<div class="container">
<h2>Créer un compte Lumio</h2>

<form id="signupForm">

<input id="emailInput" type="email" placeholder="Email" required>
<input id="passwordInput" type="password" placeholder="Mot de passe" required>
<input id="confirmInput" type="password" placeholder="Confirmer mot de passe" required>

<input id="usernameInput" placeholder="Nom d’utilisateur public" required>

<label>Date de naissance</label>
<input id="birthInput" type="date" required>

<select id="countryInput" required>
  <option value="">Pays</option>
  <option value="HT">Haïti</option>
  <option value="FR">France</option>
  <option value="CA">Canada</option>
</select>

<select id="languageInput">
  <option value="fr">Français</option>
  <option value="en">English</option>
</select>

<label>Photo de profil</label>
<input id="photoInput" type="file" accept="image/*" required>

<label>
  <input type="checkbox" id="createChannelCheckbox">
  Je veux créer une chaîne
</label>

<!-- Formulaire chaîne -->
<div id="channelForm">
  <input id="channelNameInput" placeholder="Nom de la chaîne" required>
  <textarea id="channelDescInput" placeholder="Description de la chaîne (optionnelle)"></textarea>
</div>

<div class="error" id="error"></div>

<button type="submit">Créer le compte</button>
</form>
</div>
</body>
</html>
