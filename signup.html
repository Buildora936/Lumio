<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Créer un compte – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const form = document.getElementById("signupForm");
const errorBox = document.getElementById("error");

function isTempEmail(email){
  return /(mailinator|tempmail|10minutemail|guerrillamail)/i.test(email);
}

function toBase64(file){
  return new Promise((res, rej)=>{
    const r = new FileReader();
    r.onload = ()=>res(r.result);
    r.onerror = err=>rej(err);
    r.readAsDataURL(file);
  });
}

form.onsubmit = async e => {
  e.preventDefault();
  errorBox.textContent = "";

  const email = emailInput.value.trim();
  const password = passwordInput.value;
  const confirm = confirmInput.value;
  const username = usernameInput.value.trim().toLowerCase();
  const fullName = fullNameInput.value.trim();
  const country = countryInput.value;
  const language = languageInput.value;
  const bio = bioInput.value;
  const photo = photoInput.files[0];
  const accepted = termsInput.checked && privacyInput.checked;

  if(password !== confirm) return errorBox.textContent = "Les mots de passe ne correspondent pas";
  if(password.length < 8) return errorBox.textContent = "Mot de passe trop court";
  if(!/\d/.test(password)) return errorBox.textContent = "Ajoute un chiffre";
  if(!/[a-zA-Z]/.test(password)) return errorBox.textContent = "Ajoute une lettre";
  if(isTempEmail(email)) return errorBox.textContent = "Email temporaire refusé";
  if(!photo) return errorBox.textContent = "Photo obligatoire";
  if(!accepted) return errorBox.textContent = "Accepte les conditions";

  const usernameSnap = await get(ref(db, "usernames/" + username));
  if(usernameSnap.exists()) return errorBox.textContent = "Username déjà utilisé";

  const photoBase64 = await toBase64(photo);
  const cred = await createUserWithEmailAndPassword(auth, email, password);
  const uid = cred.user.uid;

  await set(ref(db, "users/" + uid), {
    email,
    username,
    fullName: fullName || null,
    photoURL: photoBase64,
    bio,
    country,
    language,
    role: "user",
    verified: false,
    createdAt: Date.now()
  });

  await set(ref(db, "usernames/" + username), uid);

  location.href = "add-channel.html";
};
</script>

<style>
body{margin:0;font-family:system-ui;background:#0f0f0f;color:white}
.container{max-width:420px;margin:40px auto;padding:20px}
input,select,textarea,button{
  width:100%;margin:8px 0;padding:12px;
  border-radius:10px;border:none;background:#1f1f1f;color:white
}
button{background:white;color:black;font-weight:600;cursor:pointer}
label{font-size:14px}
.error{color:#ff5555;font-size:14px}
</style>
</head>

<body>
<div class="container">
<h2>Créer un compte Lumio</h2>

<form id="signupForm">
<input id="emailInput" type="email" placeholder="Email" required>
<input id="passwordInput" type="password" placeholder="Mot de passe" required>
<input id="confirmInput" type="password" placeholder="Confirmer mot de passe" required>

<input id="usernameInput" placeholder="Nom d’utilisateur public" required>
<input id="fullNameInput" placeholder="Nom complet (optionnel)">

<select id="countryInput" required>
<option value="">Pays</option>
<option value="HT">Haïti</option>
<option value="FR">France</option>
<option value="CA">Canada</option>
</select>

<select id="languageInput">
<option value="fr">Français</option>
<option value="en">English</option>
</select>

<input id="photoInput" type="file" accept="image/*" required>

<textarea id="bioInput" maxlength="1000" placeholder="Bio (1000 caractères max)"></textarea>

<label><input type="checkbox" id="termsInput"> J’accepte les conditions</label><br>
<label><input type="checkbox" id="privacyInput"> J’accepte la politique de confidentialité</label>

<div class="error" id="error"></div>

<button type="submit">Créer le compte</button>
</form>
</div>
</body>
</html>
