<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Cr√©er un Live - Lumio Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  margin:0;
  background:#0f0f0f;
  font-family:system-ui;
  color:white;
}

.container{
  max-width:800px;
  margin:40px auto;
  background:#181818;
  padding:30px;
  border-radius:16px;
}

h2{
  margin-top:0;
}

input, textarea{
  width:100%;
  padding:12px;
  margin-bottom:15px;
  border:none;
  border-radius:8px;
  background:#222;
  color:white;
}

button{
  background:#ff0000;
  border:none;
  padding:12px 18px;
  border-radius:8px;
  color:white;
  font-weight:600;
  cursor:pointer;
}

button:disabled{
  opacity:0.6;
  cursor:not-allowed;
}

.progress-container{
  width:100%;
  height:10px;
  background:#333;
  border-radius:10px;
  overflow:hidden;
  margin-bottom:10px;
  display:none;
}

.progress-bar{
  height:100%;
  width:0%;
  background:#ff0000;
  transition:width 0.2s;
}

.progress-text{
  font-size:13px;
  color:#aaa;
  margin-bottom:15px;
}

.success{
  color:#00ff88;
  margin-top:15px;
}

.error{
  color:#ff4444;
  margin-top:15px;
}
</style>
</head>

<body>

<div class="container">
  <h2>üöÄ Cr√©er un Live</h2>

  <input id="title" placeholder="Titre du live">
  <textarea id="description" rows="4"
   placeholder="Description du live"></textarea>

  <input type="file" id="thumbnailInput" accept="image/*">

  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="progress-text" id="progressText"></div>

  <button id="createBtn">Cr√©er le Live</button>

  <div id="message"></div>
</div>

<script type="module">
import { initializeApp }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase,ref,set }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

import { createClient }
from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL="https://ymcrkbcsuloijemdbqzy.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltY3JrYmNzdWxvaWplbWRicXp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTg0OTUsImV4cCI6MjA4NTg5NDQ5NX0.DH7S5cdFSwD5i1RNs_QYyubJUar8ANtdEImyj1ZqOjw";

const supabase=createClient(SUPABASE_URL,SUPABASE_KEY);

const firebaseConfig={
 apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
 authDomain:"lumio-6efed.firebaseapp.com",
 databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
 projectId:"lumio-6efed"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getDatabase(app);

let currentUser=null;

onAuthStateChanged(auth,u=>{
 if(!u) location.href="login.html";
 currentUser=u;
});

const createBtn=document.getElementById("createBtn");
const progressBar=document.getElementById("progressBar");
const progressText=document.getElementById("progressText");
const progressContainer=document.getElementById("progressContainer");
const message=document.getElementById("message");

createBtn.onclick=async()=>{

 const title=document.getElementById("title").value.trim();
 const description=document.getElementById("description").value.trim();
 const file=document.getElementById("thumbnailInput").files[0];

 if(!title || !file){
   alert("Titre et miniature obligatoires");
   return;
 }

 createBtn.disabled=true;
 progressContainer.style.display="block";
 progressBar.style.width="0%";
 progressText.textContent="Upload en cours...";

 const fileName=`live_${Date.now()}_${file.name}`;

 const {data,error}=await supabase.storage
   .from("thumbnails")
   .upload(fileName,file,{
     onUploadProgress: (progress)=>{
       const percent=Math.round(
         (progress.loaded/progress.total)*100
       );
       progressBar.style.width=percent+"%";
       progressText.textContent=percent+"%";
     }
   });

 if(error){
   message.innerHTML="<div class='error'>Erreur upload</div>";
   createBtn.disabled=false;
   return;
 }

 const {data:publicUrlData}=supabase.storage
   .from("thumbnails")
   .getPublicUrl(fileName);

 const liveId="live_"+Date.now();

 await set(ref(db,"lives/"+liveId),{
   title,
   description,
   thumbnail:publicUrlData.publicUrl,
   creatorId:currentUser.uid,
   channelName:currentUser.displayName || "Cr√©ateur",
   status:"waiting",
   createdAt:Date.now()
 });

 message.innerHTML=
  "<div class='success'>‚úÖ Live lanc√© avec succ√®s !</div>";

 setTimeout(()=>{
   location.href="live-control.html?id="+liveId;
 },1500);
};
</script>

</body>
</html>
