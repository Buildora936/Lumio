<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Live â€“ Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  background:#181818;
  color:white;
  font-family:system-ui;
}

/* HEADER */
header{
  height:56px;
  background:#0f0f0f;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}
header h2{margin:0;font-size:18px}

/* LAYOUT */
.main{
  display:flex;
  gap:12px;
  padding:12px;
}
@media(max-width:900px){
  .main{flex-direction:column}
}

/* PLAYER */
.player-box{
  flex:2;
}
.player{
  width:100%;
  height:360px;
  background:#000;
  border-radius:14px;
  display:flex;
  align-items:center;
  justify-content:center;
}
.player span{
  color:#ff5555;
  font-weight:700;
  font-size:18px;
}
.live-info{
  margin-top:10px;
}
.channel{
  display:flex;
  align-items:center;
  gap:10px;
}
.channel img{
  width:40px;
  height:40px;
  border-radius:50%;
}
.views{
  font-size:13px;
  color:#aaa;
}

/* CHAT */
.chat-box{
  flex:1;
  background:#202020;
  border-radius:14px;
  display:flex;
  flex-direction:column;
  height:520px;
}
.chat-header{
  padding:12px;
  border-bottom:1px solid #333;
  font-weight:600;
}
.messages{
  flex:1;
  padding:10px;
  overflow-y:auto;
}
.msg{
  margin-bottom:8px;
  font-size:14px;
}
.msg b{color:#ff9800}
.chat-input{
  display:flex;
  gap:6px;
  padding:10px;
  border-top:1px solid #333;
}
.chat-input input{
  flex:1;
  padding:10px;
  border-radius:20px;
  border:none;
  background:#121212;
  color:white;
}
.chat-input button{
  background:#ff6a00;
  border:none;
  padding:10px 16px;
  border-radius:20px;
  cursor:pointer;
  color:white;
  font-weight:600;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, get, push, set, onChildAdded, runTransaction } 
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth, onAuthStateChanged } 
  from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const app = initializeApp({
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
});

const db = getDatabase(app);
const auth = getAuth(app);

const liveId = new URLSearchParams(location.search).get("id");
if(!liveId) location.href="index.html";

const titleBox = document.getElementById("title");
const channelNameBox = document.getElementById("channelName");
const channelImg = document.getElementById("channelImg");
const viewsBox = document.getElementById("views");
const messagesBox = document.getElementById("messages");

let currentUser = null;

/* AUTH */
onAuthStateChanged(auth,user=>{
  currentUser = user;
});

/* LOAD LIVE */
const liveRef = ref(db,"lives/"+liveId);
const snap = await get(liveRef);
if(!snap.exists()) location.href="index.html";

const live = snap.val();

titleBox.textContent = live.title;
channelNameBox.textContent = live.channelName;
channelImg.src = live.thumbnailBase64;
viewsBox.textContent = "ðŸ”´ EN DIRECT";

/* VIEWERS COUNT */
runTransaction(ref(db,`lives/${liveId}/viewersCount`), v => (v||0)+1);
window.addEventListener("beforeunload", ()=>{
  runTransaction(ref(db,`lives/${liveId}/viewersCount`), v => Math.max((v||1)-1,0));
});

/* CHAT */
onChildAdded(ref(db,"liveChats/"+liveId), snap=>{
  const m = snap.val();
  const div = document.createElement("div");
  div.className="msg";
  div.innerHTML = `<b>${m.user}</b> : ${m.text}`;
  messagesBox.appendChild(div);
  messagesBox.scrollTop = messagesBox.scrollHeight;
});

window.sendMsg = async ()=>{
  const input = document.getElementById("msgInput");
  const text = input.value.trim();
  if(!text) return;

  await push(ref(db,"liveChats/"+liveId),{
    text,
    user: currentUser?.displayName || "InvitÃ©",
    uid: currentUser?.uid || null,
    createdAt: Date.now()
  });
  input.value="";
};
</script>
</head>

<body>

<header>
  <h2>Lumio Live</h2>
  <button onclick="location.href='index.html'">Quitter</button>
</header>

<div class="main">

  <div class="player-box">
    <div class="player">
      <span>ðŸ”´ LIVE EN COURS</span>
    </div>

    <div class="live-info">
      <h3 id="title">...</h3>
      <div class="channel">
        <img id="channelImg">
        <div>
          <div id="channelName"></div>
          <div class="views" id="views"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-box">
    <div class="chat-header">ðŸ’¬ Chat en direct</div>
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input id="msgInput" placeholder="Ã‰crire un message...">
      <button onclick="sendMsg()">Envoyer</button>
    </div>
  </div>

</div>

</body>
</html>
