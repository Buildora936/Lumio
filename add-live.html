<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lancer un Live â€“ Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{
  margin:0;
  background:#181818;
  color:white;
  font-family:system-ui;
}
header{
  height:56px;
  background:#0f0f0f;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}
header h2{
  margin:0;
  font-weight:600;
}
.container{
  max-width:800px;
  margin:40px auto;
  background:#202020;
  padding:24px;
  border-radius:14px;
}
h3{
  margin-top:0;
  border-bottom:1px solid #333;
  padding-bottom:10px;
}
input,textarea,select{
  width:100%;
  background:#121212;
  border:none;
  color:white;
  padding:10px;
  border-radius:8px;
  margin-top:6px;
}
label{
  font-size:14px;
  color:#aaa;
}
button{
  background:#ff6a00;
  border:none;
  padding:12px 20px;
  border-radius:20px;
  color:white;
  font-weight:600;
  cursor:pointer;
}
.preview{
  margin-top:10px;
  width:100%;
  height:180px;
  background:#000;
  border-radius:10px;
  background-size:cover;
  background-position:center;
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, push, set, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let channels = {};

onAuthStateChanged(auth, async user => {
  if(!user){
    alert("Connexion obligatoire");
    location.href = "login.html";
    return;
  }
  currentUser = user;

  const snap = await get(ref(db, `users/${user.uid}/channels`));
  if(!snap.exists()){
    alert("Tu dois crÃ©er une chaÃ®ne d'abord.");
    location.href = "add-channel.html";
    return;
  }
  channels = snap.val();

  const select = document.getElementById("channelSelect");
  Object.entries(channels).forEach(([id, ch])=>{
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = ch.name;
    select.appendChild(opt);
  });
});

let thumbnailBase64 = "";

document.getElementById("thumb").addEventListener("change", e=>{
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = ()=>{
    thumbnailBase64 = reader.result;
    document.getElementById("preview").style.backgroundImage =
      `url('${thumbnailBase64}')`;
  }
  reader.readAsDataURL(file);
});

document.getElementById("liveForm").addEventListener("submit", async e=>{
  e.preventDefault();

  const title = titleInput.value.trim();
  const description = descInput.value.trim();
  const channelId = channelSelect.value;

  if(!title || !channelId || !thumbnailBase64){
    alert("Champs obligatoires manquants");
    return;
  }

  const liveRef = push(ref(db,"lives"));
  const liveId = liveRef.key;

  const channelName = channels[channelId].name;

  const liveData = {
    title,
    description,
    channelId,
    channelName,
    thumbnailBase64,
    status:"live",
    viewersCount:0,
    createdAt:Date.now(),
    ownerUid:currentUser.uid
  };

  await set(liveRef, liveData);
  await set(ref(db,`channels/${channelId}/lives/${liveId}`), true);
  await set(ref(db,`users/${currentUser.uid}/lives/${liveId}`), true);

  alert("ðŸ”´ Live lancÃ© avec succÃ¨s !");
  location.href = `live.html?id=${liveId}`;
});
</script>
</head>

<body>

<header>
  <h2>Lumio</h2>
  <button onclick="location.href='index.html'">Retour</button>
</header>

<div class="container">
  <h3>Lancer un live</h3>

  <form id="liveForm">

    <label>ChaÃ®ne</label>
    <select id="channelSelect" required>
      <option value="">-- SÃ©lectionne une chaÃ®ne --</option>
    </select>

    <label>Titre du live</label>
    <input id="titleInput" maxlength="100" required>

    <label>Description</label>
    <textarea id="descInput" rows="3"></textarea>

    <label>Miniature (Thumbnail)</label>
    <input type="file" id="thumb" accept="image/*" required>

    <div class="preview" id="preview"></div>

    <br><br>
    <button type="submit">ðŸ”´ Lancer le Live</button>

  </form>
</div>

</body>
</html>
