<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lancer un live ‚Äì Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#0f0f0f;
  color:white;
}
header{
  height:56px;
  background:#181818;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}
header h2{margin:0;font-size:18px}

.container{
  max-width:520px;
  margin:40px auto;
  background:#181818;
  padding:20px;
  border-radius:16px;
}

h3{margin-top:0}

input,textarea,select,button{
  width:100%;
  margin-top:10px;
  padding:12px;
  border-radius:12px;
  border:none;
  background:#222;
  color:white;
}

textarea{resize:none;height:100px}

button{
  background:#ff0000;
  font-weight:700;
  cursor:pointer;
}

.progress{
  margin-top:14px;
  height:10px;
  background:#222;
  border-radius:20px;
  overflow:hidden;
}
.progress div{
  height:100%;
  width:0%;
  background:#ff0000;
  transition:.2s;
}

.error{
  margin-top:10px;
  color:#ff5555;
  font-size:14px;
}
</style>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script type="module">
import { initializeApp } from
 "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, push, set, query, orderByChild, equalTo }
 from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* üî• FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

/* üß† SUPABASE */
const SUPABASE_URL = "https://ymcrkbcsuloijemdbqzy.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltY3JrYmNzdWxvaWplbWRicXp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzMTg0OTUsImV4cCI6MjA4NTg5NDQ5NX0.DH7S5cdFSwD5i1RNs_QYyubJUar8ANtdEImyj1ZqOjw";

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_KEY
);

let currentUser=null;
let channelId=null;
let channelName="", channelPhotoURL="";

/* üîê AUTH */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="auth.html";
  currentUser=user;

  const uc = await get(ref(db,"userChannels/"+user.uid));
  if(!uc.exists()) return location.href="add-channel.html";

  channelId = uc.val();
  const ch = await get(ref(db,"channels/"+channelId));
  const c = ch.val();

  channelName = c.name;
  channelPhotoURL = c.photoURL;

  document.getElementById("channelName").textContent = channelName;
});

/* üöÄ CREATE LIVE */
form.onsubmit = async e=>{
  e.preventDefault();
  error.textContent="";
  bar.style.width="0%";

  const title = titleInput.value.trim();
  const description = descInput.value.trim();
  const thumb = thumbInput.files[0];

  if(!title || !thumb){
    error.textContent="Titre et miniature obligatoires";
    return;
  }

  try{
    /* ‚õî CHECK LIVE EXIST */
    const q = query(
      ref(db,"lives"),
      orderByChild("channelId"),
      equalTo(channelId)
    );
    const snap = await get(q);
    let hasLive=false;
    snap.forEach(l=>{
      if(l.val().status==="live") hasLive=true;
    });
    if(hasLive){
      error.textContent="Un live est d√©j√† en cours sur cette cha√Æne";
      return;
    }

    /* üÜî LIVE ID */
    const liveRef = push(ref(db,"lives"));
    const liveId = liveRef.key;

    bar.style.width="20%";

    /* üñºÔ∏è UPLOAD THUMB */
    const thumbPath = `live-thumbnails/${liveId}.jpg`;
    const { error:upErr } = await supabase
      .storage.from("thumbnails")
      .upload(thumbPath, thumb, { upsert:true });

    if(upErr) throw upErr;

    bar.style.width="60%";

    const thumbURL =
      `${SUPABASE_URL}/storage/v1/object/public/thumbnails/${thumbPath}`;

    /* üíæ SAVE LIVE */
    await set(liveRef,{
      title,
      description,
      thumbnailURL: thumbURL,

      channelId,
      channelName,
      channelPhotoURL,

      status:"live",
      chatEnabled:true,
      likes:0,
      viewersCount:0,
      startedAt:Date.now()
    });

    bar.style.width="100%";

    location.href = `live-control.html?id=${liveId}`;

  }catch(err){
    console.error(err);
    error.textContent = err.message;
  }
};
</script>
</head>

<body>

<header>
  <h2>Lancer un live üî¥</h2>
</header>

<div class="container">
  <h3>Cha√Æne : <span id="channelName">...</span></h3>

  <form id="form">
    <input id="titleInput" placeholder="Titre du live *">
    <textarea id="descInput" placeholder="Description"></textarea>

    <label>Miniature du live *</label>
    <input id="thumbInput" type="file" accept="image/*">

    <button type="submit">üî¥ Lancer le live</button>

    <div class="progress"><div id="bar"></div></div>
    <div class="error" id="error"></div>
  </form>
</div>

</body>
</html>
