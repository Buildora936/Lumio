<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Chaîne – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#181818">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{background:#181818;color:white}

/* HEADER CHANNEL */
.channel-header{
  background:#0f0f0f;
  padding:20px;
  display:flex;
  gap:20px;
  align-items:center;
}
.channel-header img{
  width:90px;
  height:90px;
  border-radius:50%;
  object-fit:cover;
}
.channel-info{flex:1}
.channel-info h1{font-size:22px}
.channel-info p{color:#aaa;margin-top:6px;font-size:14px}
.channel-info span{font-size:13px;color:#888}

.subscribe-btn{
  padding:10px 20px;
  border-radius:20px;
  border:none;
  font-weight:700;
  cursor:pointer;
}
.subscribe{
  background:#ff9800;
  color:black;
}
.subscribed{
  background:#eee;
  color:black;
}

/* GRID */
.content{padding:16px}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:16px;
}

/* CARD */
.card{
  background:#202020;
  border-radius:14px;
  overflow:hidden;
  border:1px solid #262626;
  cursor:pointer;
}
.thumb{
  height:140px;
  background:#2a2a2a;
  background-size:cover;
  background-position:center;
}
.card-body{padding:10px}
.title{font-weight:600;margin-bottom:6px}
.desc{font-size:13px;color:#aaa;margin-bottom:4px}
.meta{font-size:12px;color:#888}

/* SKELETON */
.skeleton{animation:pulse 1.2s infinite}
@keyframes pulse{0%{opacity:.6}50%{opacity:.3}100%{opacity:.6}}
</style>
</head>

<body>

<!-- CHANNEL HEADER -->
<div class="channel-header">
  <img id="channelPhoto" src="default-channel.png">
  <div class="channel-info">
    <h1 id="channelName">Chargement…</h1>
    <p id="channelDesc"></p>
    <span id="channelSubs"></span>
  </div>
  <button id="subBtn" class="subscribe-btn subscribe">S’abonner</button>
</div>

<!-- VIDEOS -->
<div class="content">
  <div class="grid" id="grid"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, onValue, set, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* Firebase */
const app = initializeApp({
  apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain:"lumio-6efed.firebaseapp.com",
  databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId:"lumio-6efed"
});
const auth = getAuth(app);
const db = getDatabase(app);

/* Elements */
const grid = document.getElementById("grid");
const subBtn = document.getElementById("subBtn");

const channelId = new URLSearchParams(location.search).get("id");
let currentUser = null;

/* Skeleton */
for(let i=0;i<6;i++){
  grid.innerHTML += `
  <div class="card skeleton">
    <div class="thumb"></div>
    <div class="card-body">
      <div class="title">&nbsp;</div>
      <div class="desc">&nbsp;</div>
      <div class="meta">&nbsp;</div>
    </div>
  </div>`;
}

/* AUTH */
onAuthStateChanged(auth,user=>{
  currentUser = user;
  if(user) checkSubscription();
});

/* LOAD CHANNEL */
(async()=>{
  const snap = await get(ref(db,"channels/"+channelId));
  if(!snap.exists()) return alert("Chaîne introuvable");

  const c = snap.val();
  channelPhoto.src = c.photoURL || "default-channel.png";
  channelName.textContent = c.name;
  channelDesc.textContent = c.description || "";
})();

/* LOAD SUBS COUNT */
onValue(ref(db,"subscriptions/"+channelId),snap=>{
  const count = snap.exists() ? Object.keys(snap.val()).length : 0;
  channelSubs.textContent = `${count} abonnés`;
});

/* SUBSCRIBE */
async function checkSubscription(){
  const s = await get(ref(db,`subscriptions/${channelId}/${currentUser.uid}`));
  if(s.exists()){
    subBtn.textContent="Abonné";
    subBtn.className="subscribe-btn subscribed";
  }
}

subBtn.onclick = async ()=>{
  if(!currentUser) return location.href="auth.html";
  const subRef = ref(db,`subscriptions/${channelId}/${currentUser.uid}`);
  const snap = await get(subRef);

  if(snap.exists()){
    await remove(subRef);
    subBtn.textContent="S’abonner";
    subBtn.className="subscribe-btn subscribe";
  }else{
    await set(subRef,true);
    subBtn.textContent="Abonné";
    subBtn.className="subscribe-btn subscribed";
  }
};

/* LOAD VIDEOS */
onValue(ref(db,"videos"),snap=>{
  grid.innerHTML="";
  if(!snap.exists()) return;

  Object.entries(snap.val())
    .filter(([id,v])=>v.channelId===channelId)
    .forEach(([id,v])=>{
      const card=document.createElement("div");
      card.className="card";
      card.onclick=()=>location.href=`player.html?id=${id}`;

      card.innerHTML=`
        <div class="thumb" style="background-image:url('${v.thumbnailBase64||""}')"></div>
        <div class="card-body">
          <div class="title">${v.title}</div>
          <div class="desc">${v.description||""}</div>
          <div class="meta">${v.views||0} vues</div>
        </div>`;
      grid.appendChild(card);
    });
});
</script>

</body>
</html>
