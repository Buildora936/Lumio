<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Créer une chaîne – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;

onAuthStateChanged(auth, user => {
  if (!user) location.href = "signup.html";
  else currentUser = user;
});

// Convertir image en base64
function toBase64(file) {
  return new Promise(res => {
    const reader = new FileReader();
    reader.onload = () => res(reader.result);
    reader.readAsDataURL(file);
  });
}

// Gestion du formulaire
let currentStep = 0;
const steps = document.querySelectorAll(".step");
const progressBar = document.querySelector(".progress-bar");

function showStep(n) {
  steps.forEach((step, i) => step.style.display = i === n ? "block" : "none");
  progressBar.style.width = ((n + 1) / steps.length) * 100 + "%";
}
showStep(currentStep);

function nextStep() {
  if (currentStep < steps.length - 1) {
    currentStep++;
    showStep(currentStep);
  }
}

function prevStep() {
  if (currentStep > 0) {
    currentStep--;
    showStep(currentStep);
  }
}

document.getElementById("channelForm").onsubmit = async e => {
  e.preventDefault();
  if (!currentUser) return;

  const name = document.getElementById("channelName").value.trim();
  const description = document.getElementById("channelDesc").value.trim();
  const lang = document.getElementById("channelLang").value;
  const visibility = document.getElementById("channelVisibility").value;

  const profileFile = document.getElementById("channelProfile").files[0];
  const bannerFile = document.getElementById("channelBanner").files[0];

  if (!name || !profileFile || !bannerFile) {
    alert("Veuillez remplir tous les champs obligatoires.");
    return;
  }

  const profileBase64 = await toBase64(profileFile);
  const bannerBase64 = await toBase64(bannerFile);

  const channelRef = push(ref(db, "channels"));
  await set(channelRef, {
    userId: currentUser.uid,
    name,
    description,
    profileBase64,
    bannerBase64,
    lang,
    visibility,
    createdAt: Date.now()
  });

  // Rediriger vers la page de la chaîne
  location.href = `channel.html?id=${channelRef.key}`;
};
</script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#181818;color:white;}
main{max-width:600px;margin:80px auto;padding:24px;background:#202020;border-radius:14px;}
h2{text-align:center;margin-bottom:20px;}
input,textarea,select{width:100%;padding:12px;margin-bottom:14px;border:none;border-radius:8px;background:#2a2a2a;color:white;}
label{display:flex;align-items:center;gap:10px;margin-bottom:14px;font-weight:600;}
button{width:100%;padding:14px;background:#ff6a00;border:none;border-radius:20px;font-weight:700;cursor:pointer;margin-bottom:10px;}
button:hover{background:#ffa633;}
.progress-container{background:#333;height:8px;width:100%;border-radius:4px;margin-bottom:20px;overflow:hidden;}
.progress-bar{background:#ff6a00;height:8px;width:0%;transition:0.4s;}
.step{display:none;}
.step .title{font-weight:600;margin-bottom:10px;}
.step-buttons{display:flex;justify-content:space-between;}
</style>
</head>

<body>

<main>
  <h2>Créer votre chaîne Lumio</h2>

  <div class="progress-container">
    <div class="progress-bar"></div>
  </div>

  <form id="channelForm">

    <!-- Étape 1 -->
    <div class="step">
      <div class="title">Étape 1 – Infos de base</div>
      <input id="channelName" placeholder="Nom de la chaîne" required>
      <textarea id="channelDesc" placeholder="Description (optionnel)"></textarea>
      <div class="step-buttons">
        <div></div>
        <button type="button" onclick="nextStep()">Suivant →</button>
      </div>
    </div>

    <!-- Étape 2 -->
    <div class="step">
      <div class="title">Étape 2 – Images</div>
      <label>Photo de profil
        <input type="file" id="channelProfile" accept="image/*" required>
      </label>
      <label>Bannière
        <input type="file" id="channelBanner" accept="image/*" required>
      </label>
      <div class="step-buttons">
        <button type="button" onclick="prevStep()">← Précédent</button>
        <button type="button" onclick="nextStep()">Suivant →</button>
      </div>
    </div>

    <!-- Étape 3 -->
    <div class="step">
      <div class="title">Étape 3 – Paramètres & Finalisation</div>
      <label>Langue
        <select id="channelLang">
          <option value="fr">Français</option>
          <option value="en">English</option>
          <option value="es">Español</option>
        </select>
      </label>
      <label>Visibilité
        <select id="channelVisibility">
          <option value="public">Publique</option>
          <option value="private">Privée</option>
        </select>
      </label>
      <div class="step-buttons">
        <button type="button" onclick="prevStep()">← Précédent</button>
        <button type="submit">Créer la chaîne</button>
      </div>
    </div>

  </form>
</main>

</body>
</html>
