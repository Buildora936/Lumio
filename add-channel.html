<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Créer une chaîne – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#181818;color:white;}
.container{max-width:480px;margin:60px auto;padding:25px;background:#0f0f0f;border-radius:16px;box-shadow:0 0 25px #000;}
h2{text-align:center;margin-bottom:20px;font-weight:700;color:#ff9800;}
input,select,textarea,button{width:100%;margin:10px 0;padding:12px;border-radius:12px;border:none;background:#1f1f1f;color:white;}
textarea{resize:none;}
button{background:#ff9800;color:black;font-weight:700;cursor:pointer;transition:.3s;}
button:hover{background:#e68a00;}
.error{color:#ff5555;text-align:center;font-size:14px}
.progress{height:18px;background:#222;border-radius:10px;overflow:hidden;margin:10px 0}
.bar{height:100%;width:0;background:#ff9800;transition:.4s}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, push, get, child } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const config={
 apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
 authDomain:"lumio-6efed.firebaseapp.com",
 databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
 projectId:"lumio-6efed"
};

const app=initializeApp(config);
const db=getDatabase(app);
const auth=getAuth(app);

let user=null;

const bar=()=>document.getElementById("bar");
const errBox=()=>document.getElementById("error");

function progress(p){bar().style.width=p+"%";}

function toBase64(file){
 return new Promise((res,rej)=>{
  const r=new FileReader();
  r.onload=()=>res(r.result);
  r.onerror=rej;
  r.readAsDataURL(file);
 });
}

onAuthStateChanged(auth,async u=>{
 if(!u){location.href="auth.html";return;}
 user=u;

 const snap=await get(child(ref(db),"userChannels/"+u.uid));
 if(snap.exists()){
  alert("Tu as déjà une chaîne.");
  location.href="dashboard.html";
 }
});

window.createChannel=async(e)=>{
 e.preventDefault();
 errBox().textContent="";
 progress(5);

 if(!user)return errBox().textContent="Utilisateur non connecté";

 const name=nameInput.value.trim();
 const desc=descInput.value.trim();
 const photo=photoInput.files[0];
 const banner=bannerInput.files[0];
 const cat=catInput.value;

 if(!name||!desc||!photo)
  return errBox().textContent="Remplis tous les champs obligatoires.";

 try{
  const photo64=await toBase64(photo);
  const banner64=banner?await toBase64(banner):"";

  progress(30);

  const chRef=push(ref(db,"channels"));
  const id=chRef.key;

  await set(chRef,{
   id,
   name,
   description:desc,
   category:cat,
   owner:user.uid,
   photoURL:photo64,
   bannerURL:banner64,
   createdAt:Date.now(),
   monetization:true,
   comments:true
  });

  progress(60);

  await set(ref(db,"userChannels/"+user.uid),id);

  const walletRef=ref(db,"wallets/"+user.uid);
  const w=await get(walletRef);

  if(!w.exists()){
   await set(walletRef,{
    balance:0,
    earned:0,
    withdrawn:0
   });
  }

  progress(75);

  const token=await user.getIdToken();

  await fetch("https://ymcrkbcsuloijemdbqzy.supabase.co/functions/v1/create-wallet",{
   method:"POST",
   headers:{
    "Content-Type":"application/json",
    "Authorization":"Bearer "+token
   },
   body:JSON.stringify({uid:user.uid})
  });

  progress(100);

  alert("Chaîne créée !");
  location.href="connect-stripe.html";

 }catch(err){
  console.error(err);
  errBox().textContent="Erreur serveur.";
 }
}
</script>
</head>

<body>
<div class="container">

<h2>Créer ta chaîne</h2>

<form onsubmit="createChannel(event)">
<input id="nameInput" placeholder="Nom chaîne">
<textarea id="descInput" placeholder="Description"></textarea>

<label>Photo</label>
<input id="photoInput" type="file" accept="image/*">

<label>Bannière</label>
<input id="bannerInput" type="file" accept="image/*">

<select id="catInput">
<option>Divers</option>
<option>Gaming</option>
<option>Musique</option>
<option>Education</option>
</select>

<div class="progress"><div id="bar" class="bar"></div></div>
<div id="error" class="error"></div>

<button>Créer la chaîne</button>
</form>

</div>
</body>
