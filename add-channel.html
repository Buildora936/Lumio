<!DOCTYPE html>  
<html lang="fr">  
<head>  
<meta charset="UTF-8">  
<title>Créer une chaîne – Lumio</title>  
<meta name="viewport" content="width=device-width, initial-scale=1.0">  
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">  
  
<style>  
*{box-sizing:border-box}  
body{margin:0;font-family:system-ui;background:#181818;color:white;}  
.container{max-width:480px;margin:60px auto;padding:25px;background:#0f0f0f;border-radius:16px;box-shadow:0 0 25px #000;}  
h2{text-align:center;margin-bottom:20px;font-weight:700;color:#ff9800;}  
input, select, textarea, button{width:100%;margin:10px 0;padding:12px;border-radius:12px;border:none;background:#1f1f1f;color:white;}  
textarea{resize:none;}  
button{background:#ff9800;color:black;font-weight:700;cursor:pointer;transition:0.3s;}  
button:hover{background:#e68a00;}  
label{font-size:14px;margin-top:8px;display:block;}  
.error{color:#ff5555;text-align:center;font-size:14px;margin-top:8px;}  
.progress-container{margin:20px 0;background:#202020;border-radius:12px;overflow:hidden;height:20px;}  
.progress-bar{height:100%;width:0%;background:#ff9800;transition:width 0.5s ease;}  
</style>  
  
<script type="module">  
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";  
import { getDatabase, ref, set, push, get, child } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";  
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";  
  
const firebaseConfig = {  
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",  
  authDomain: "lumio-6efed.firebaseapp.com",  
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",  
  projectId: "lumio-6efed"  
};  
  
const app = initializeApp(firebaseConfig);  
const db = getDatabase(app);  
const auth = getAuth(app);  
  
function toBase64(file){  
  return new Promise((res, rej)=>{  
    const r = new FileReader();  
    r.onload = ()=>res(r.result);  
    r.onerror = e=>rej(e);  
    r.readAsDataURL(file);  
  });  
}  
  
function updateProgress(percent){  
  document.getElementById("progressBar").style.width = percent+"%";  
}  
  
window.onload = ()=>{  
  let currentUser = null;  
  onAuthStateChanged(auth, async user => {  
    if(!user){  
      alert("Connecte-toi pour créer une chaîne");  
      location.href="auth.html";  
      return;  
    }  
    currentUser = user;  

    // Vérifier si l'utilisateur a déjà une chaîne
    const userChannelsSnap = await get(child(ref(db), "userChannels/" + user.uid));  
    if(userChannelsSnap.exists()){  
      alert("Vous avez déjà une chaîne.");  
      location.href="publish.html";  
      return;  
    }  
  });  
  
  const form = document.getElementById("channelForm");  
  const errorBox = document.getElementById("error");  
  
  form.onsubmit = async e=>{  
    e.preventDefault();  
    errorBox.textContent = "";  
    updateProgress(0);  
  
    if(!currentUser){  
      errorBox.textContent="Connecte-toi pour créer une chaîne";  
      return;  
    }  
  
    const channelName = document.getElementById("channelName").value.trim();  
    const channelDesc = document.getElementById("channelDesc").value.trim();  
    const channelPhoto = document.getElementById("channelPhoto").files[0];  
    const channelBanner = document.getElementById("channelBanner").files[0];  
    const channelCategory = document.getElementById("channelCategory").value;  
  
    if(!channelName) return errorBox.textContent="Nom de chaîne obligatoire";  
    if(!channelDesc) return errorBox.textContent="Description obligatoire";  
    if(!channelPhoto) return errorBox.textContent="Photo de chaîne obligatoire";  
  
    try{  
      const photoC = await toBase64(channelPhoto);  
      const bannerC = channelBanner ? await toBase64(channelBanner) : "";  
  
      updateProgress(50);  
  
      const channelRef = push(ref(db,"channels"));  
      const channelId = channelRef.key;  
  
      // Créer la chaîne
      await set(channelRef,{  
        name: channelName,  
        description: channelDesc,  
        owner: currentUser.uid,  
        photoURL: photoC,  
        bannerURL: bannerC || "",  
        category: channelCategory,  
        visibility: "public",  
        monetization: true,  
        commentsEnabled: true,  
        mvEnabled: true,  
        createdAt: Date.now()  
      });  

      // Ajouter référence dans userChannels pour vérifier ensuite
      await set(ref(db, "userChannels/" + currentUser.uid), channelId);  
  
      updateProgress(100);  
      alert("Chaîne créée avec succès !");  
      location.href=`publish.html`;  
    }catch(err){  
      console.error(err);  
      errorBox.textContent=err.message;  
    }  
  }  
};  
</script>  
</head>  
  
<body>  
<div class="container">  
<h2>Créer votre chaîne Lumio</h2>  
  
<form id="channelForm">  
  <input id="channelName" placeholder="Nom de la chaîne" required>  
  <textarea id="channelDesc" placeholder="Description de la chaîne" required></textarea>  
  
  <label>Photo de la chaîne</label>  
  <input id="channelPhoto" type="file" accept="image/*" required>  
  
  <label>Bannière de la chaîne (optionnel)</label>  
  <input id="channelBanner" type="file" accept="image/*">  
  
  <label>Catégorie</label>  
  <select id="channelCategory">  
    <option value="Divers">Divers</option>  
    <option value="Musique">Musique</option>  
    <option value="Gaming">Gaming</option>  
    <option value="Éducation">Éducation</option>  
  </select>  
  
  <div class="progress-container">  
    <div id="progressBar" class="progress-bar"></div>  
  </div>  
  
  <div class="error" id="error"></div>  
  <button type="submit">Créer la chaîne</button>  
</form>  
</div>  
</body>  
</html>
