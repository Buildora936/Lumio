<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Créer une chaîne – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#181818;color:white;}
.container{max-width:480px;margin:60px auto;padding:25px;background:#0f0f0f;border-radius:16px;box-shadow:0 0 25px #000;}
h2{text-align:center;margin-bottom:20px;font-weight:700;color:#ff9800;}
input,select,textarea,button{width:100%;margin:10px 0;padding:12px;border-radius:12px;border:none;background:#1f1f1f;color:white;}
textarea{resize:none;}
button{background:#ff9800;color:black;font-weight:700;cursor:pointer}
.error{color:#ff5555;text-align:center;font-size:14px;margin-top:8px;}
.progress{margin:20px 0;height:18px;background:#222;border-radius:10px;overflow:hidden}
.bar{height:100%;width:0;background:#ff9800;transition:.3s}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, push, get, child } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const app = initializeApp({
 apiKey:"AIzaSyD5u...",
 authDomain:"lumio-6efed.firebaseapp.com",
 databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
 projectId:"lumio-6efed"
});

const db=getDatabase(app);
const auth=getAuth(app);

const to64=f=>new Promise(r=>{
 const fr=new FileReader();
 fr.onload=()=>r(fr.result);
 fr.readAsDataURL(f);
});

function setBar(p){
 document.getElementById("bar").style.width=p+"%";
}

window.onload = ()=>{    
  let currentUser = null;    
  onAuthStateChanged(auth, async user => {    
    if(!user){    
      alert("Connecte-toi pour créer une chaîne");    
      location.href="auth.html";    
      return;    
    }    
    currentUser = user;    
  

 const snap=await get(child(ref(db),"userChannels/"+u.uid));
 if(snap.exists()){
   alert("Vous avez déjà une chaîne");
   location.href="publish.html";
 }
});

window.submitChannel=async()=>{

 const btn=document.getElementById("submitBtn");
 btn.disabled=true;
 btn.textContent="Création...";

 try{

 const name=channelName.value.trim();
 const desc=channelDesc.value.trim();
 const photo=channelPhoto.files[0];
 const banner=channelBanner.files[0];

 if(!name||!desc||!photo) throw Error("Champs obligatoires manquants");

 setBar(20);

 const photo64=await to64(photo);
 const banner64=banner?await to64(banner):"";

 setBar(40);

 const refChan=push(ref(db,"channels"));
 const id=refChan.key;

 await set(refChan,{
  name,
  description:desc,
  owner:user.uid,
  photoURL:photo64,
  bannerURL:banner64,
  category:channelCategory.value,
  createdAt:Date.now()
 });

 await set(ref(db,"userChannels/"+user.uid),id);

 setBar(60);

 // wallet firebase
 const walletRef=ref(db,"wallets/"+user.uid);
 const w=await get(walletRef);
 if(!w.exists()){
  await set(walletRef,{balance:0,totalEarned:0,totalWithdrawn:0});
 }

 setBar(80);

 // wallet supabase
 const res=await fetch("https://ymcrkbcsuloijemdbqzy.supabase.co/functions/v1/create-wallet",{
  method:"POST",
  headers:{
   "Content-Type":"application/json",
   "Authorization":"Bearer "+await user.getIdToken()
  },
  body:JSON.stringify({uid:user.uid})
 });

 const data=await res.json();
 if(!data.success) throw Error(data.error||"Wallet error");

 setBar(100);

 alert("Chaîne créée avec succès");

 location.href="connect-stripe.html";

 }catch(e){
  error.textContent=e.message;
  btn.disabled=false;
  btn.textContent="Créer la chaîne";
 }
};
</script>
</head>

<body>
<div class="container">

<h2>Créer votre chaîne</h2>

<input id="channelName" placeholder="Nom de la chaîne">
<textarea id="channelDesc" placeholder="Description"></textarea>

<label>Photo</label>
<input id="channelPhoto" type="file" accept="image/*">

<label>Bannière</label>
<input id="channelBanner" type="file" accept="image/*">

<select id="channelCategory">
<option>Divers</option>
<option>Musique</option>
<option>Gaming</option>
<option>Éducation</option>
</select>

<div class="progress">
<div id="bar" class="bar"></div>
</div>

<div id="error" class="error"></div>

<button id="submitBtn" onclick="submitChannel()">Créer la chaîne</button>

</div>
</body>
</html>
