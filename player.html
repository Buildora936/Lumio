<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lecture ‚Äì Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{margin:0;background:#0f0f0f;color:white;font-family:system-ui}
.container{max-width:900px;margin:auto;padding:10px}
video{width:100%;border-radius:12px;background:black}
.channel{display:flex;align-items:center;gap:10px;margin:10px 0}
.channel img{width:40px;height:40px;border-radius:50%}
.comments{margin-top:20px}
.comment{background:#1f1f1f;padding:8px;border-radius:8px;margin:6px 0}
input,button{
  width:100%;padding:10px;margin-top:6px;
  border:none;border-radius:10px;
  background:#1f1f1f;color:white;
}
button{background:white;color:black;font-weight:600}
.recommendations{margin-top:30px}
.rec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:16px}
.card{background:#202020;border-radius:14px;overflow:hidden;cursor:pointer}
.thumb{height:140px;background-size:cover;background-position:center}
.card-body{padding:10px}
.title{font-weight:600}
.meta{font-size:12px;color:#aaa}
.ad-card{background:#202020;border-radius:14px;border:1px solid #333;overflow:hidden;cursor:default}
.ad-thumb{height:140px;display:flex;align-items:center;justify-content:center;background:#111}
.ad-label{font-size:11px;color:#ff9800;text-transform:uppercase;font-weight:600}
.ad-body{padding:10px}
.ad-title{font-weight:600;font-size:14px}
.ad-meta{font-size:12px;color:#aaa}
</style>
</head>

<body>

<div class="container">
  <video id="videoPlayer" controls></video>

  <h2 id="videoTitle"></h2>
  <div id="videoViews"></div>

  <div class="channel">
    <img id="channelAvatar">
    <a id="channelLink" style="color:white;text-decoration:none">
      <span id="channelName"></span>
    </a>
  </div>

  <p id="videoDesc"></p>

  <div class="comments">
    <h3>Commentaires</h3>
    <form id="commentForm">
      <input id="commentInput" placeholder="√âcrire un commentaire...">
      <button>Publier</button>
    </form>
    <div id="comments"></div>
  </div>

  <div class="recommendations">
    <h3>Vid√©os recommand√©es</h3>
    <div class="rec-grid" id="recGrid"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, get, update, push, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const params = new URLSearchParams(location.search);
const videoId = params.get("id");
let currentUser = null;

onAuthStateChanged(auth,user=>{currentUser=user});

if(!videoId){
  alert("Vid√©o introuvable");
  location.href="index.html";
}

const videoPlayer=document.getElementById("videoPlayer");
const videoTitle=document.getElementById("videoTitle");
const videoDesc=document.getElementById("videoDesc");
const videoViews=document.getElementById("videoViews");
const channelName=document.getElementById("channelName");
const channelAvatar=document.getElementById("channelAvatar");
const channelLink=document.getElementById("channelLink");
const comments=document.getElementById("comments");
const commentForm=document.getElementById("commentForm");
const commentInput=document.getElementById("commentInput");
const recGrid=document.getElementById("recGrid");

async function loadVideo(){
  const snap=await get(ref(db,"videos/"+videoId));
  if(!snap.exists()){
    alert("Vid√©o supprim√©e");
    location.href="index.html";
    return;
  }
  const v=snap.val();
  videoPlayer.src=v.videoBase64; // Base64 ou URL
  videoTitle.textContent=v.title;
  videoDesc.textContent=v.description||"";
  videoViews.textContent=(v.views||0)+" vues";

  // Increment views
  await update(ref(db,"videos/"+videoId),{views:(v.views||0)+1});

  // Load channel info
  const chSnap=await get(ref(db,"channels/"+v.channelId));
  if(chSnap.exists()){
    const ch=chSnap.val();
    channelName.textContent=ch.name;
    channelAvatar.src=ch.avatar||"";
    channelLink.href="channel.html?id="+v.channelId;
  }

  loadComments();
  loadRecommendations();
}

async function loadComments(){
  comments.innerHTML="";
  const snap=await get(ref(db,"comments/"+videoId));
  if(!snap.exists()) return;
  for(const id in snap.val()){
    const c=snap.val()[id];
    const div=document.createElement("div");
    div.className="comment";
    div.innerHTML=`<b>${c.username}</b><p>${c.text}</p>`;
    comments.appendChild(div);
  }
}

commentForm.onsubmit=async e=>{
  e.preventDefault();
  if(!currentUser){alert("Connecte-toi pour commenter");return;}
  const text=commentInput.value.trim();
  if(!text) return;
  const userSnap=await get(ref(db,"users/"+currentUser.uid));
  const user=userSnap.val();
  const cRef=push(ref(db,"comments/"+videoId));
  await set(cRef,{uid:currentUser.uid,username:user.username,text,createdAt:Date.now()});
  commentInput.value="";
  loadComments();
}

async function loadRecommendations(){
  const snap=await get(ref(db,"videos"));
  if(!snap.exists()) return;
  recGrid.innerHTML="";
  let count=0;
  Object.entries(snap.val())
    .sort((a,b)=>b[1].createdAt-b[1].createdAt)
    .forEach(([id,v])=>{
      if(id===videoId) return; // skip current video
      const card=document.createElement("div");
      card.className="card";
      card.onclick=()=>location.href="player.html?id="+id;
      card.innerHTML=`
        <div class="thumb" style="background-image:url('${v.thumbnailBase64}')"></div>
        <div class="card-body">
          <div class="title">${v.title}</div>
          <div class="meta">${v.channelName} | ${v.views||0} vues</div>
        </div>
      `;
      recGrid.appendChild(card);
      count++;
      if(count%6===0){
        const ad=document.createElement("div");
        ad.className="ad-card";
        ad.innerHTML=`<div class="ad-thumb">üí∞ Pub Lumio</div>
        <div class="ad-body">
          <div class="ad-label">Publicit√©</div>
          <div class="ad-title">Sponsoris√©</div>
          <div class="ad-meta">Annonce Lumio</div>
        </div>`;
        recGrid.appendChild(ad);
      }
    });
}

loadVideo();
</script>

</body>
</html>
