<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lecture vidéo – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui;}
body{background:#181818;color:white;}

header{
  height:56px;background:#0f0f0f;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;
}
header h1{font-size:18px}
header button{background:#202020;color:white;border:none;padding:6px 12px;border-radius:12px;}

/* LECTEUR */
.video-container{
  max-width:900px;margin:60px auto 20px auto;
  padding:0 16px;
}
video{
  width:100%;border-radius:14px;background:#000;
}

/* INFOS VIDEO */
.video-info{
  margin-top:12px;padding:10px;
  background:#0f0f0f;border-radius:14px;
}
.video-info h2{font-size:18px;margin-bottom:6px;}
.video-info p{font-size:14px;color:#aaa;margin-bottom:6px;}

/* CHANNEL ROW */
.channel-row{
  display:flex;align-items:center;gap:12px;margin-bottom:10px;
}
.channel-row img{width:40px;height:40px;border-radius:50%;object-fit:cover;}
.channel-row .name{font-weight:600;font-size:14px;}
.subscribe-btn{
  margin-left:auto;padding:8px 14px;
  border:none;border-radius:20px;
  font-weight:700;
  cursor:pointer;
  background:#ff9800;color:black;
  transition:0.3s;
}
.subscribe-btn.subscribed{background:#fff;color:black;}

/* ACTIONS */
.actions{
  display:flex;gap:16px;margin-top:10px;
}
.actions button{
  background:#202020;color:white;
  border:none;padding:8px 12px;border-radius:12px;
  cursor:pointer;display:flex;align-items:center;gap:6px;
}

/* SKELETON */
.skeleton{
  background:#222;
  border-radius:14px;
  height:20px;
  margin-bottom:6px;
  animation:pulse 1.2s infinite;
}
@keyframes pulse{0%{opacity:.6}50%{opacity:.3}100%{opacity:.6}}

/* PUB CARD */
.ad-card{
  background:#181818;border:1px solid #333;
  border-radius:14px;padding:10px;text-align:center;margin:16px 0;
}
</style>
</head>
<body>

<header>
  <button onclick="history.back()"><i class="fa fa-arrow-left"></i></button>
  <h1>Lecture vidéo</h1>
  <button onclick="location.href='index.html'">Accueil</button>
</header>

<div class="video-container">
  <!-- Skeleton loading -->
  <div id="videoSkeleton" class="skeleton" style="height:360px;"></div>
  <div class="video-info" id="infoSkeleton">
    <div class="skeleton" style="width:60%"></div>
    <div class="skeleton" style="width:40%"></div>
    <div class="skeleton" style="width:30%"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase,ref,get,update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app=initializeApp({
  apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain:"lumio-6efed.firebaseapp.com",
  databaseURL:"https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId:"lumio-6efed"
});
const auth=getAuth(app);
const db=getDatabase(app);

let videoId=(new URLSearchParams(location.search)).get("id");
let currentUser=null;

// Auth
onAuthStateChanged(auth,user=>{
  if(user) currentUser=user;
});

// Utils Base64 → URL
const base64ToBlobURL=base64=>{
  const [header,data]=base64.split(",");
  const mime=header.match(/:(.*?);/)[1];
  const binary=atob(data);
  const array=Uint8Array.from(binary,c=>c.charCodeAt(0));
  return URL.createObjectURL(new Blob([array],{type:mime}));
};

(async function(){
  const snap=await get(ref(db,"videos/"+videoId));
  if(!snap.exists()){alert("Vidéo introuvable");return;}
  const v=snap.val();

  // VIDEO
  const videoEl=document.createElement("video");
  videoEl.src=base64ToBlobURL(v.videoURL);
  videoEl.controls=true;
  videoEl.autoplay=true;
  videoEl.playsInline=true;

  const container=document.querySelector(".video-container");
  document.getElementById("videoSkeleton").remove();
  container.prepend(videoEl);

  // INFOS VIDEO
  const infoDiv=document.createElement("div");
  infoDiv.className="video-info";
  infoDiv.innerHTML=`
    <h2>${v.title}</h2>
    <p>${v.description||""}</p>
    <div class="channel-row">
      <img src="${v.channelPhotoURL||'default-channel.png'}">
      <span class="name">${v.channelName||"Chaîne"}</span>
      <button id="subscribeBtn" class="subscribe-btn">S'abonner</button>
    </div>
    <div class="actions">
      <button id="likeBtn"><i class="fa fa-thumbs-up"></i> ${v.likes||0}</button>
      <button id="dislikeBtn"><i class="fa fa-thumbs-down"></i></button>
      <button id="favBtn"><i class="fa fa-star"></i></button>
      <button id="shareBtn"><i class="fa fa-share"></i></button>
    </div>
  `;
  document.getElementById("infoSkeleton").remove();
  container.appendChild(infoDiv);

  // SUBSCRIBE
  const subBtn=document.getElementById("subscribeBtn");
  const subRef=ref(db,"subscriptions/"+(currentUser?.uid||"")+"/"+v.channelId);
  if(currentUser){
    const s=await get(subRef);
    if(s.exists()) subBtn.classList.add("subscribed"),subBtn.textContent="Abonné";
  }

  subBtn.onclick=async()=>{
    if(!currentUser){alert("Connecte-toi !");return;}
    const path="subscriptions/"+currentUser.uid+"/"+v.channelId;
    if(subBtn.classList.contains("subscribed")){
      await update(ref(db,path),null);
      subBtn.classList.remove("subscribed");
      subBtn.textContent="S'abonner";
    }else{
      await update(ref(db,path),true);
      subBtn.classList.add("subscribed");
      subBtn.textContent="Abonné";
    }
  };

  // LIKE / DISLIKE
  const likeBtn=document.getElementById("likeBtn");
  likeBtn.onclick=async()=>{
    if(!currentUser){alert("Connecte-toi !");return;}
    const likeRef=ref(db,"videoLikes/"+videoId+"/"+currentUser.uid);
    const snap=await get(likeRef);
    if(snap.exists()){
      await update(likeRef,null);
      v.likes--;likeBtn.textContent=`${v.likes}`;
    }else{
      await update(likeRef,true);
      v.likes++;likeBtn.textContent=`${v.likes}`;
    }
  };

})();
</script>

</body>
</html>
