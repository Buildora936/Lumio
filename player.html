<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lumio ‚Äì Lecture</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, set, onValue, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let videoId = new URLSearchParams(window.location.search).get("id");

onAuthStateChanged(auth, user=>{
  currentUser = user;
});

// üîπ Charger la vid√©o
const videoPlayer = document.getElementById("videoPlayer");
const titleEl = document.getElementById("videoTitle");
const descEl = document.getElementById("videoDesc");
const channelNameEl = document.getElementById("channelName");
const subsCountEl = document.getElementById("subsCount");
const subscribeBtn = document.getElementById("subscribeBtn");
const likeBtn = document.getElementById("likeBtn");
const dislikeBtn = document.getElementById("dislikeBtn");
const saveBtn = document.getElementById("saveBtn");
const recommendationsGrid = document.getElementById("recommendations");

async function loadVideo() {
  if(!videoId) return alert("Vid√©o introuvable");

  const snap = await get(ref(db,"videos/"+videoId));
  if(!snap.exists()) return alert("Vid√©o introuvable");
  const v = snap.val();

  videoPlayer.src = v.videoBase64;
  titleEl.textContent = v.title;
  descEl.textContent = v.description || "";
  channelNameEl.textContent = v.channelName;

  // Vue automatique
  const views = (v.views || 0) + 1;
  update(ref(db,"videos/"+videoId), {views});

  // Charger abonn√©s
  const subsSnap = await get(ref(db,"channels/"+v.channelId+"/subscribers"));
  subsCountEl.textContent = (subsSnap.exists()? Object.keys(subsSnap.val()).length : 0) + " abonn√©s";

  // D√©tecter si l'utilisateur est abonn√©
  if(currentUser && subsSnap.exists() && subsSnap.val()[currentUser.uid]) {
    subscribeBtn.textContent = "Abonn√©";
    subscribeBtn.disabled = true;
  }

  // Charger recommandations (MV et autres)
  onValue(ref(db,"videos"), recSnap=>{
    recommendationsGrid.innerHTML="";
    if(!recSnap.exists()) return;
    Object.entries(recSnap.val())
      .filter(([id])=>id!==videoId)
      .slice(0,8)
      .forEach(([id,v])=>{
        const card = document.createElement("div");
        card.className="recCard";
        card.onclick = ()=> location.href="player.html?id="+id;
        card.innerHTML=`
          <div class="thumb" style="background-image:url('${v.thumbnailBase64}')"></div>
          <div class="title">${v.title}</div>
        `;
        recommendationsGrid.appendChild(card);
      });
  });
}

loadVideo();

// üîπ Actions
subscribeBtn.onclick = async ()=>{
  if(!currentUser) return alert("Connectez-vous pour vous abonner");
  await set(ref(db,"channels/"+channelNameEl.textContent+"/subscribers/"+currentUser.uid),true);
  subscribeBtn.textContent="Abonn√©";
  subscribeBtn.disabled=true;
};

likeBtn.onclick = async ()=>{
  if(!currentUser) return alert("Connectez-vous pour liker");
  const snap = await get(ref(db,"videos/"+videoId+"/likes"));
  const likes = snap.exists()? snap.val()+1 : 1;
  set(ref(db,"videos/"+videoId+"/likes"), likes);
  alert("Vous aimez cette vid√©o !");
};

dislikeBtn.onclick = async ()=>{
  if(!currentUser) return alert("Connectez-vous pour ne pas aimer");
  const snap = await get(ref(db,"videos/"+videoId+"/dislikes"));
  const dislikes = snap.exists()? snap.val()+1 : 1;
  set(ref(db,"videos/"+videoId+"/dislikes"), dislikes);
  alert("Vous n'aimez pas cette vid√©o !");
};

saveBtn.onclick = async ()=>{
  if(!currentUser) return alert("Connectez-vous pour enregistrer");
  await set(ref(db,"users/"+currentUser.uid+"/savedVideos/"+videoId), true);
  alert("Vid√©o enregistr√©e sur Lumio !");
};

</script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#181818;color:white;}
header{position:fixed;top:0;left:0;right:0;height:56px;background:#0f0f0f;display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:10}
.left,.center,.right{display:flex;align-items:center;gap:14px}
button{background:#202020;color:white;border:none;padding:8px 14px;border-radius:20px;cursor:pointer}
.content{margin-top:64px;padding:16px;max-width:960px;margin-left:auto;margin-right:auto}
.videoContainer{width:100%;max-height:480px;overflow:hidden;background:#000;border-radius:12px;margin-bottom:16px}
video{width:100%;border-radius:12px}
.actions{display:flex;gap:12px;margin:8px 0}
.channelInfo{display:flex;align-items:center;gap:12px;margin:12px 0}
.recGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:24px}
.recCard{cursor:pointer;background:#202020;border-radius:10px;overflow:hidden}
.recCard .thumb{height:100px;background-size:cover;background-position:center}
.recCard .title{padding:6px;font-size:12px}
</style>
</head>

<body>

<header>
  <div class="left"><h2>Lumio</h2></div>
  <div class="center">
    <input id="searchInput" placeholder="Rechercher sur Lumio">
  </div>
  <div class="right">
    <button onclick="location.href='upload.html'"><i class="fa-solid fa-plus"></i></button>
    <button onclick="location.href='channel.html'"><i class="fa-solid fa-user"></i></button>
  </div>
</header>

<div class="content">
  <div class="videoContainer">
    <video id="videoPlayer" controls></video>
  </div>
  <h2 id="videoTitle"></h2>
  <div class="channelInfo">
    <span id="channelName"></span> | <span id="subsCount"></span>
  </div>
  <p id="videoDesc"></p>

  <div class="actions">
    <button id="likeBtn"><i class="fa-regular fa-thumbs-up"></i> Like</button>
    <button id="dislikeBtn"><i class="fa-regular fa-thumbs-down"></i> Je n'aime pas</button>
    <button id="subscribeBtn">S'abonner</button>
    <button id="saveBtn"><i class="fa-solid fa-bookmark"></i> Enregistrer</button>
  </div>

  <h3>Recommandations</h3>
  <div id="recommendations" class="recGrid"></div>
</div>

</body>
</html>
