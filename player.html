<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Player – Lumio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#181818">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:system-ui}
body{background:#181818;color:white;overflow:hidden}

/* HEADER */
header{
  position:fixed;top:0;left:0;right:0;height:56px;
  display:flex;align-items:center;justify-content:space-between;
  background:#0f0f0f;padding:0 12px;z-index:10;
}
header h1{font-size:18px;font-weight:600}
header button{background:#202020;color:white;border:none;padding:6px 12px;border-radius:12px;cursor:pointer}

/* VIDEO PLAYER */
#videoContainer{
  width:100%;height:calc(100vh - 56px);position:relative;display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
video{
  width:100%;height:100%;object-fit:cover;
}

/* INFO PANEL */
.info{
  position:absolute;bottom:0;left:0;width:100%;background:linear-gradient(transparent,#181818);
  padding:16px;color:white;
}
.info h2{margin-bottom:6px;font-size:20px}
.info p{font-size:14px;color:#ccc;margin-bottom:6px}
.channel-row{display:flex;align-items:center;gap:8px;margin-top:6px}
.channel-row img{width:36px;height:36px;border-radius:50%;object-fit:cover}
.meta{font-size:13px;color:#aaa}

/* LIKES & VUES */
.stats{display:flex;gap:12px;margin-top:6px}
.stats div{display:flex;align-items:center;gap:6px;font-size:13px;color:#aaa}

/* COMMENT MODAL */
.comment-modal{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);
  display:none;flex-direction:column;z-index:20;
}
.comment-modal .header{
  display:flex;justify-content:space-between;align-items:center;padding:12px;
  border-bottom:1px solid #333;
}
.comment-modal .header h3{font-size:16px}
.comment-modal .header button{background:none;border:none;color:white;font-size:20px;cursor:pointer}
.comment-modal .list{flex:1;overflow-y:auto;padding:12px}
.comment-modal .list .comment{margin-bottom:10px;border-bottom:1px solid #333;padding-bottom:6px}
.comment-modal .list .comment strong{font-size:14px}
.comment-modal .add-comment{display:flex;padding:12px;border-top:1px solid #333;gap:6px}
.comment-modal .add-comment input{flex:1;padding:8px;border-radius:12px;border:none;background:#222;color:white}
.comment-modal .add-comment button{padding:8px 12px;border-radius:12px;background:#ff8800;border:none;color:black;font-weight:700;cursor:pointer}

/* SWIPE UP */
.swipe-hint{
  position:absolute;bottom:80px;left:50%;transform:translateX(-50%);
  color:#aaa;font-size:12px;animation:swipe 1.5s infinite;
}
@keyframes swipe{
  0%,100%{opacity:0}
  50%{opacity:1}
}
</style>
</head>

<body>

<header>
  <button onclick="history.back()"><i class="fa-solid fa-arrow-left"></i></button>
  <h1 id="videoTitle">Chargement…</h1>
  <button id="commentBtn"><i class="fa-solid fa-comment"></i></button>
</header>

<div id="videoContainer">
  <video id="videoPlayer" controls autoplay></video>
  <div class="info">
    <h2 id="videoTitle2"></h2>
    <p id="videoDesc"></p>
    <div class="channel-row">
      <img id="channelPhoto" src="default-channel.png">
      <div class="meta"><span id="channelName">Chaîne</span></div>
    </div>
    <div class="stats">
      <div><i class="fa-solid fa-eye"></i> <span id="views">0</span></div>
      <div><i class="fa-solid fa-heart"></i> <span id="likes">0</span></div>
    </div>
  </div>
  <div class="swipe-hint">⬆️ Balayez vers le haut pour la prochaine vidéo</div>
</div>

<div class="comment-modal" id="commentModal">
  <div class="header">
    <h3>Commentaires</h3>
    <button id="closeComments">&times;</button>
  </div>
  <div class="list" id="commentList"></div>
  <div class="add-comment">
    <input id="commentInput" placeholder="Ajouter un commentaire…">
    <button id="sendComment">Envoyer</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
});
const auth = getAuth(app);
const db = getDatabase(app);

let videoId = new URLSearchParams(location.search).get("id");
let videoData = null;
let currentUser = null;

/* AUTH */
onAuthStateChanged(auth,user=>{currentUser=user});

/* ELEMENTS */
const videoPlayer = document.getElementById("videoPlayer");
const videoTitle = document.getElementById("videoTitle");
const videoTitle2 = document.getElementById("videoTitle2");
const videoDesc = document.getElementById("videoDesc");
const channelName = document.getElementById("channelName");
const channelPhoto = document.getElementById("channelPhoto");
const viewsEl = document.getElementById("views");
const likesEl = document.getElementById("likes");

const commentBtn = document.getElementById("commentBtn");
const commentModal = document.getElementById("commentModal");
const closeComments = document.getElementById("closeComments");
const commentList = document.getElementById("commentList");
const commentInput = document.getElementById("commentInput");
const sendComment = document.getElementById("sendComment");

/* LOAD VIDEO */
async function loadVideo(id){
  const snap = await get(ref(db,"videos/"+id));
  if(!snap.exists()) return alert("Vidéo introuvable");
  videoData = snap.val();

  videoPlayer.src = videoData.videoBase64 || "";
  videoTitle.textContent = videoData.title;
  videoTitle2.textContent = videoData.title;
  videoDesc.textContent = videoData.description || "";
  channelName.textContent = videoData.channelName || "Chaîne";
  channelPhoto.src = videoData.channelPhotoURL || "default-channel.png";

  viewsEl.textContent = videoData.views || 0;
  likesEl.textContent = videoData.likes || 0;

  // Increment views
  await set(ref(db,"videos/"+id+"/views"),(videoData.views||0)+1);
}

/* COMMENTS */
commentBtn.onclick = ()=>commentModal.style.display="flex";
closeComments.onclick = ()=>commentModal.style.display="none";

async function loadComments(){
  commentList.innerHTML="";
  const snap = await get(ref(db,"comments/"+videoId));
  if(!snap.exists()) return;
  Object.entries(snap.val()).forEach(([id,c])=>{
    const div = document.createElement("div");
    div.className="comment";
    div.innerHTML=`<strong>${c.userName||"Utilisateur"}:</strong> ${c.text}`;
    commentList.appendChild(div);
  });
}
sendComment.onclick = async ()=>{
  if(!currentUser) return location.href="auth.html";
  const text = commentInput.value.trim();
  if(!text) return;
  const commentRef = push(ref(db,"comments/"+videoId));
  await set(commentRef,{userId:currentUser.uid,userName:currentUser.displayName,text});
  commentInput.value="";
  loadComments();
};

/* SWIPE UP NEXT VIDEO */
let touchStartY = 0;
videoPlayer.addEventListener("touchstart",e=>{touchStartY=e.touches[0].clientY});
videoPlayer.addEventListener("touchend",async e=>{
  const diff = touchStartY - e.changedTouches[0].clientY;
  if(diff>50){ // swipe up
    const videosSnap = await get(ref(db,"videos"));
    if(!videosSnap.exists()) return;
    const allVideos = Object.keys(videosSnap.val());
    const nextId = allVideos[Math.floor(Math.random()*allVideos.length)];
    location.href = `player.html?id=${nextId}`;
  }
});

loadVideo(videoId);
loadComments();
</script>

</body>
</html>
