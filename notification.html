<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Lumio â€“ Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const list = document.getElementById("list");

let currentUser = null;

onAuthStateChanged(auth, user => {
  if (!user) return location.href = "auth.html";
  currentUser = user;
  loadNotifications();
});

function loadNotifications(){
  const notifRef = ref(db, "notifications/" + currentUser.uid);

  onValue(notifRef, snap => {
    list.innerHTML = "";

    if(!snap.exists()){
      list.innerHTML = `<p class="empty">Aucune notification</p>`;
      return;
    }

    const data = Object.entries(snap.val())
      .sort((a,b) => b[1].createdAt - a[1].createdAt);

    data.forEach(([id, n]) => {
      const div = document.createElement("div");
      div.className = "notif " + (n.seen ? "" : "unseen");

      div.innerHTML = `
        <div class="icon">
          <i class="fa-solid ${iconByType(n.type)}"></i>
        </div>
        <div class="content">
          <div class="msg">${n.message}</div>
          <div class="time">${new Date(n.createdAt).toLocaleString()}</div>
        </div>
        <div class="actions">
          ${!n.seen ? `<button onclick="markSeen('${id}')">Vu</button>` : ""}
        </div>
      `;

      div.onclick = () => {
        if(n.videoId){
          location.href = "player.html?id=" + n.videoId;
        }
      };

      list.appendChild(div);
    });
  });
}

window.markSeen = function(id){
  update(ref(db, `notifications/${currentUser.uid}/${id}`), {
    seen: true
  });
}

function iconByType(type){
  if(type === "comment") return "fa-comment";
  if(type === "like") return "fa-thumbs-up";
  if(type === "sub") return "fa-user-plus";
  if(type === "monetization") return "fa-dollar-sign";
  return "fa-bell";
}
</script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:#181818;
  color:white;
}

header{
  height:56px;
  background:#0f0f0f;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
}

header h2{margin:0;font-size:18px}

main{
  max-width:800px;
  margin:20px auto;
  padding:10px;
}

.notif{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  background:#202020;
  border-radius:12px;
  margin-bottom:10px;
  cursor:pointer;
}

.notif.unseen{
  border-left:4px solid #ff8800;
  background:#242424;
}

.icon{
  font-size:20px;
  color:#ff8800;
}

.content{
  flex:1;
}

.msg{
  font-size:14px;
}

.time{
  font-size:11px;
  color:#aaa;
}

.actions button{
  background:#ff8800;
  border:none;
  color:white;
  padding:6px 10px;
  border-radius:12px;
  cursor:pointer;
}

.empty{
  text-align:center;
  color:#aaa;
  margin-top:40px;
}
</style>
</head>

<body>

<header>
  <h2>Notifications</h2>
  <button onclick="location.href='index.html'">
    <i class="fa-solid fa-house"></i>
  </button>
</header>

<main>
  <div id="list"></div>
  <script async="async" data-cfasync="false" src="https://pl28568106.effectivegatecpm.com/c4b323c3f978079a0b2331dd12eaf2f1/invoke.js"></script>
<div id="container-c4b323c3f978079a0b2331dd12eaf2f1"></div>
</main>
<script src="https://pl28472656.effectivegatecpm.com/62/3c/68/623c687d960057f1bb9501ec03e66b47.js"></script>
</body>
</html>
