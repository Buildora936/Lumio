<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Analytics â€“ Lumio Studio</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Elements
const walletEl = document.createElement("div");
walletEl.className = "wallet";

const statsGrid = document.getElementById("statsGrid");
const revenuePanel = document.getElementById("revenuePanel");
const salesTable = document.getElementById("salesTable");

onAuthStateChanged(auth, async user => {
  if(!user) return location.href="auth.html";
  const uid = user.uid;

  // Wallet & earnings
  const walletSnap = await get(ref(db,"wallets/"+uid));
  let balance = 0, totalEarned = 0, totalWithdrawn = 0;
  if(walletSnap.exists()){
    const w = walletSnap.val();
    balance = w.balance || 0;
    totalEarned = w.totalEarned || 0;
    totalWithdrawn = w.totalWithdrawn || 0;
  } else {
    await set(ref(db,"wallets/"+uid),{balance:0,totalEarned:0,totalWithdrawn:0});
  }
  walletEl.innerHTML = `
    <h2>ðŸ’° Wallet</h2>
    <p>Solde disponible : $${balance.toFixed(2)}</p>
    <p>Total gagnÃ© : $${totalEarned.toFixed(2)}</p>
    <p>Total retirÃ© : $${totalWithdrawn.toFixed(2)}</p>
  `;
  document.body.prepend(walletEl);

  // Load stats for books
  const booksSnap = await get(ref(db,"books"));
  let totalViews=0, totalLikes=0, totalComments=0, totalBooks=0, totalRevenue=0;

  if(booksSnap.exists()){
    Object.entries(booksSnap.val()).forEach(([bid,b])=>{
      if(b.authorChannelId !== uid) return;
      totalBooks++;
      totalViews += b.views || 0;
      totalLikes += b.likes ? Object.keys(b.likes).length : 0;
      totalComments += b.comments ? Object.keys(b.comments).length : 0;
      totalRevenue += b.salesRevenue || 0;
    });
  }

  // Update dashboard
  document.getElementById("totalBooks").innerText = totalBooks;
  document.getElementById("totalViews").innerText = totalViews;
  document.getElementById("totalLikes").innerText = totalLikes;
  document.getElementById("totalComments").innerText = totalComments;
  document.getElementById("totalRevenue").innerText = "$"+totalRevenue.toFixed(2);

  revenuePanel.style.display = "flex";

  // Sales history table
  const ordersSnap = await get(ref(db,"orders"));
  if(ordersSnap.exists()){
    salesTable.innerHTML = "";
    Object.entries(ordersSnap.val()).forEach(([oid,o])=>{
      if(o.authorId !== uid) return;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${o.bookTitle}</td>
        <td>${o.buyerEmail}</td>
        <td>$${o.amount.toFixed(2)}</td>
        <td>${new Date(o.date).toLocaleDateString()}</td>
      `;
      salesTable.appendChild(row);
    });
  }
});
</script>

<style>
body{
  margin:0;
  background:#0f0f0f;
  color:white;
  font-family:system-ui;
}
header{
  padding:20px;
  font-size:24px;
  font-weight:600;
  text-align:center;
  background:#111;
}
.wallet{
  max-width:900px;
  margin:20px auto;
  background:#1c1c1c;
  padding:16px;
  border-radius:12px;
}
.stats{
  max-width:900px;
  margin:20px auto;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:12px;
}
.card{
  background:#1c1c1c;
  padding:12px;
  border-radius:12px;
  text-align:center;
}
.card span{color:#aaa;font-size:12px}
.card h2{margin:4px 0 0}
.revenue{
  max-width:900px;
  margin:20px auto;
  display:flex;
  gap:16px;
  background:#1c1c1c;
  padding:16px;
  border-radius:12px;
  display:none;
}
.revenue div{flex:1}
table{
  width:90%;
  max-width:900px;
  margin:20px auto;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #333;
  font-size:13px;
}
th{color:#aaa;text-align:left;}
</style>
</head>

<body>
<header>ðŸ“Š Dashboard â€“ Lumio Studio</header>

<div class="stats" id="statsGrid">
  <div class="card"><span>Livres</span><h2 id="totalBooks">0</h2></div>
  <div class="card"><span>Vues</span><h2 id="totalViews">0</h2></div>
  <div class="card"><span>Likes</span><h2 id="totalLikes">0</h2></div>
  <div class="card"><span>Commentaires</span><h2 id="totalComments">0</h2></div>
</div>

<div class="revenue" id="revenuePanel">
  <div>ðŸ’° Revenu total : <b id="totalRevenue">$0</b></div>
</div>

<table>
  <thead>
    <tr>
      <th>Livre</th>
      <th>Acheteur</th>
      <th>Montant</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="salesTable"></tbody>
</table>
</body>
</html>
