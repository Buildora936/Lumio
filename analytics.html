<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Analytics â€“ Lumio Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const stripeBadgeEl = document.createElement("div");
stripeBadgeEl.style.margin = "16px";
stripeBadgeEl.style.padding = "12px";
stripeBadgeEl.style.borderRadius = "12px";
stripeBadgeEl.style.background = "#1c1c1c";
stripeBadgeEl.style.color = "white";
stripeBadgeEl.style.fontWeight = "700";

onAuthStateChanged(auth, async user => {
  if(!user){
    location.href="auth.html";
    return;
  }

  const uid = user.uid;

  /* ========= CHECK STRIPE ========= */
  const statusRes = await fetch(
    "https://ymcrkbcsuloijemdbqzy.supabase.co/functions/v1/check-stripe-status",
    {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":"Bearer "+await user.getIdToken()
      },
      body:JSON.stringify({ uid })
    }
  );
  const stripeStatus = await statusRes.json();

  if(!stripeStatus.payoutsEnabled){
    stripeBadgeEl.innerText = "âš  Stripe non configurÃ© pour les paiements";
    document.body.prepend(stripeBadgeEl);
  } else {
    stripeBadgeEl.innerText = "âœ… Stripe prÃªt pour paiements";
    document.body.prepend(stripeBadgeEl);
  }

  /* ========= EXISTING ANALYTICS LOGIC ========= */
  const videosSnap = await get(ref(db, "videos"));
  const likesSnap = await get(ref(db, "shortLikes")); 
  const commentsSnap = await get(ref(db, "comments"));
  const subsSnap = await get(ref(db, "subscriptions"));
  const monetSnap = await get(ref(db,"monetization/"+uid));

  let totalViews = 0, totalVideos = 0, totalLikes = 0, totalComments = 0, totalSubs = 0, revenue = 0, pubRevenue = 0;

  if(subsSnap.exists() && subsSnap.val()[uid]){
    totalSubs = Object.keys(subsSnap.val()[uid]).length;
  }

  const monetized = monetSnap.exists() && monetSnap.val().enabled && totalSubs >= 1000;

  const videoTable = document.getElementById("videoTable");

  if(videosSnap.exists()){
    Object.entries(videosSnap.val()).forEach(([id, v])=>{
      if(v.channelId === uid){
        totalVideos++;
        totalViews += v.views || 0;

        const likes = likesSnap.exists() && likesSnap.val()[id] ? Object.keys(likesSnap.val()[id]).length : 0;
        const comments = commentsSnap.exists() && commentsSnap.val()[id] ? Object.keys(commentsSnap.val()[id]).length : 0;

        totalLikes += likes;
        totalComments += comments;

        if(monetized){
          const rev = ((v.views || 0)/1000)*1.3;
          pubRevenue += rev;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${v.title}</td>
            <td>${v.views || 0}</td>
            <td>${likes}</td>
            <td>${comments}</td>
            <td>$${rev.toFixed(2)}</td>
          `;
          videoTable.appendChild(row);
        }
      }
    });
  }

  revenue = monetized ? (pubRevenue - 0.5) : 0;
  if(revenue < 0) revenue = 0;

  document.getElementById("views").innerText = totalViews;
  document.getElementById("videos").innerText = totalVideos;
  document.getElementById("subs").innerText = totalSubs;
  document.getElementById("likes").innerText = totalLikes;
  document.getElementById("comments").innerText = totalComments;

  if(monetized){
    document.getElementById("revenue").innerText = "$" + revenue.toFixed(2);
    document.getElementById("revenuePanel").style.display = "flex";
  } else {
    document.getElementById("revenuePanel").style.display = "none";
  }
});
</script>

<style>
body{margin:0;background:#0f0f0f;color:white;font-family:system-ui}
header{padding:20px;font-size:22px;font-weight:600}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;padding:16px}
.card{background:#1c1c1c;border-radius:12px;padding:14px}
.card span{font-size:12px;color:#aaa}
.card h2{margin:4px 0 0}
.revenue{display:flex;gap:16px;padding:16px}
.revenue div{flex:1;background:#1c1c1c;border-radius:12px;padding:12px}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:10px;border-bottom:1px solid #333;font-size:13px}
th{color:#aaa}
</style>
</head>

<body>
<header>ðŸ“Š Analytics â€“ Lumio Studio</header>

<div class="stats">
  <div class="card"><span>Vues</span><h2 id="views">0</h2></div>
  <div class="card"><span>VidÃ©os</span><h2 id="videos">0</h2></div>
  <div class="card"><span>AbonnÃ©s</span><h2 id="subs">0</h2></div>
  <div class="card"><span>Likes</span><h2 id="likes">0</h2></div>
  <div class="card"><span>Commentaires</span><h2 id="comments">0</h2></div>
</div>

<div class="revenue" id="revenuePanel" style="display:none;">
  <div>ðŸ“º Vues : <b id="revPub">$0</b></div>
  <div>ðŸ’° Revenu total : <b id="revenue">$0</b></div>
</div>

<table>
  <thead>
    <tr>
      <th>Titre</th>
      <th>Vues</th>
      <th>Likes</th>
      <th>Commentaires</th>
      <th>Revenu</th>
    </tr>
  </thead>
  <tbody id="videoTable"></tbody>
</table>
</body>
</html>
