<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Analytics â€“ Lumio Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get, set, onValue } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const walletEl = document.createElement("div");
walletEl.style.cssText = "margin:16px;padding:12px;border-radius:12px;background:#1c1c1c;color:white;font-weight:700";

const transactionsEl = document.createElement("div");
transactionsEl.style.cssText = "margin:16px;padding:12px;border-radius:12px;background:#1c1c1c;color:white";

onAuthStateChanged(auth, async user => {
  if(!user) location.href="auth.html";
  const uid = user.uid;

  // RÃ©cupÃ©ration Wallet
  const wSnap = await get(ref(db,"wallets/"+uid));
  let balance=0, totalEarned=0, totalWithdrawn=0;
  if(wSnap.exists()){
    const w = wSnap.val();
    balance = w.balance || 0;
    totalEarned = w.totalEarned || 0;
    totalWithdrawn = w.totalWithdrawn || 0;
  } else {
    await set(ref(db,"wallets/"+uid),{balance:0,totalEarned:0,totalWithdrawn:0});
  }
  walletEl.innerHTML = `ðŸ’° Solde actuel: $${balance.toFixed(2)} | Total gagnÃ©: $${totalEarned.toFixed(2)} | Total retirÃ©: $${totalWithdrawn.toFixed(2)}`;
  document.body.prepend(walletEl);

  // RÃ©cupÃ©ration ventes
  const purchasesSnap = await get(ref(db,"purchases"));
  let totalBooksSold=0, totalRevenue=0;
  const bookRevenue = {}; // par livre

  if(purchasesSnap.exists()){
    Object.values(purchasesSnap.val()).forEach(userPurchases=>{
      Object.values(userPurchases).forEach(p=>{
        if(p.bookId){
          totalBooksSold++;
          const price = p.price || 0;
          totalRevenue += price*0.85; // auteur gain
          bookRevenue[p.bookId] = (bookRevenue[p.bookId]||0) + price*0.85;
        }
      });
    });
  }

  // Stats rapide
  const statsContainer = document.getElementById("stats");
  statsContainer.querySelector("#totalBooks").textContent = totalBooksSold;
  statsContainer.querySelector("#totalRev").textContent = "$"+totalRevenue.toFixed(2);

  // Transactions rÃ©centes
  const txList = document.getElementById("txList");
  txList.innerHTML="";
  if(purchasesSnap.exists()){
    Object.entries(purchasesSnap.val()).forEach(([uid,purchases])=>{
      Object.entries(purchases).forEach(([bid,p])=>{
        const div = document.createElement("div");
        div.textContent = `LivreID:${bid} | $${(p.price||0).toFixed(2)} | Date:${new Date(p.date).toLocaleString()}`;
        txList.appendChild(div);
      });
    });
  }

  // Graphiques simples (barres par livre)
  const chartEl = document.getElementById("chart");
  chartEl.innerHTML="";
  Object.entries(bookRevenue).forEach(([bid,rev])=>{
    const bar = document.createElement("div");
    bar.style.cssText=`background:#ff6a00;height:20px;margin:4px;border-radius:4px;width:${Math.min(rev*5,300)}px;color:white;padding:2px`;
    bar.textContent = `${bid} : $${rev.toFixed(2)}`;
    chartEl.appendChild(bar);
  });

});
</script>

<style>
body{margin:0;background:#0f0f0f;color:white;font-family:system-ui}
header{padding:20px;font-size:22px;font-weight:600}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;padding:16px}
.card{background:#1c1c1c;border-radius:12px;padding:14px}
.card span{font-size:12px;color:#aaa}
.card h2{margin:4px 0 0}
.revenue{display:flex;gap:16px;padding:16px}
.revenue div{flex:1;background:#1c1c1c;border-radius:12px;padding:12px}
#txList div{padding:6px;border-bottom:1px solid #333;font-size:13px}
#chart div{margin-top:4px}
</style>
</head>

<body>
<header>ðŸ“Š Analytics â€“ Lumio Studio</header>

<div class="stats">
  <div class="card"><span>Total livres vendus</span><h2 id="totalBooks">0</h2></div>
  <div class="card"><span>Total revenu auteur</span><h2 id="totalRev">$0</h2></div>
</div>

<div class="revenue">
  <div>
    <h3>Transactions rÃ©centes</h3>
    <div id="txList"></div>
  </div>
  <div>
    <h3>Gains par livre</h3>
    <div id="chart"></div>
  </div>
</div>
</body>
</html>
