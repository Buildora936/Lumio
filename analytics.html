<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Analytics ‚Äì Lumio Studio</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
  authDomain: "lumio-6efed.firebaseapp.com",
  databaseURL: "https://lumio-6efed-default-rtdb.firebaseio.com",
  projectId: "lumio-6efed"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const CPM = 1.3; // $1.30 / 1000 vues
const TAX_PER_MONTH = 0.5; // Taxe mensuelle pour utilisateur mon√©tis√©

onAuthStateChanged(auth, async user => {
  if(!user){
    location.href = "auth.html";
    return;
  }

  const uid = user.uid;

  const videosSnap = await get(ref(db, "videos"));
  const commentsSnap = await get(ref(db, "comments"));
  const likesSnap = await get(ref(db, "likes"));
  const subsSnap = await get(ref(db, "subscriptions"));
  const donationsSnap = await get(ref(db, "donations"));
  const monetizedSnap = await get(ref(db, "monetizedUsers"));

  let totalViews = 0;
  let totalVideos = 0;
  let totalLikes = 0;
  let totalComments = 0;
  let totalSubs = 0;

  let pubRevenue = 0;
  let donationRevenue = 0;
  let tax = 0;

  const videoTable = document.getElementById("videoTable");

  // ‚úÖ Parcourir vid√©os
  if(videosSnap.exists()){
    Object.entries(videosSnap.val()).forEach(([id,v])=>{
      if(v.channelId === uid){
        totalVideos++;
        totalViews += v.views || 0;

        const likes = likesSnap.exists() && likesSnap.val()[id] ? Object.keys(likesSnap.val()[id]).length : 0;
        const comments = commentsSnap.exists() && commentsSnap.val()[id] ? Object.keys(commentsSnap.val()[id]).length : 0;

        totalLikes += likes;
        totalComments += comments;

        // Pub revenue avec CPM
        const videoRevenue = (v.views || 0) * (CPM / 1000);
        pubRevenue += videoRevenue;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${v.title}</td>
          <td>${v.views || 0}</td>
          <td>${likes}</td>
          <td>${comments}</td>
          <td>$${videoRevenue.toFixed(2)}</td>
        `;
        videoTable.appendChild(row);
      }
    });
  }

  // ‚úÖ Abonn√©s
  if(subsSnap.exists() && subsSnap.val()[uid]){
    totalSubs = Object.keys(subsSnap.val()[uid]).length;
  }

  // ‚úÖ Donations
  if(donationsSnap.exists()){
    Object.values(donationsSnap.val()).forEach(d=>{
      if(d.channelId === uid){
        donationRevenue += d.amount * 0.9; // 10% fee
      }
    });
  }

  // ‚úÖ Taxe mensuelle
  if(monetizedSnap.exists() && monetizedSnap.val()[uid]){
    tax = TAX_PER_MONTH;
  }

  const totalRevenue = pubRevenue + donationRevenue - tax;

  // Affichage stats
  document.getElementById("views").innerText = totalViews;
  document.getElementById("videos").innerText = totalVideos;
  document.getElementById("subs").innerText = totalSubs;
  document.getElementById("likes").innerText = totalLikes;
  document.getElementById("comments").innerText = totalComments;
  document.getElementById("revenue").innerText = "$" + totalRevenue.toFixed(2);

  document.getElementById("revPub").innerText = "$" + pubRevenue.toFixed(2);
  document.getElementById("revDon").innerText = "$" + donationRevenue.toFixed(2);
  document.getElementById("tax").innerText = "-$" + tax.toFixed(2);
});
</script>

<style>
body{
  margin:0;
  background:#0f0f0f;
  color:white;
  font-family:system-ui;
}
header{
  padding:20px;
  font-size:22px;
  font-weight:600;
}

.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:12px;
  padding:16px;
}
.card{
  background:#1c1c1c;
  border-radius:12px;
  padding:14px;
}
.card span{
  font-size:12px;
  color:#aaa;
}
.card h2{
  margin:4px 0 0;
}

.revenue{
  display:flex;
  gap:16px;
  padding:16px;
}
.revenue div{
  flex:1;
  background:#1c1c1c;
  border-radius:12px;
  padding:12px;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th,td{
  padding:10px;
  border-bottom:1px solid #333;
  font-size:13px;
}
th{
  color:#aaa;
}
</style>
</head>

<body>

<header>üìä Analytics ‚Äì Lumio Studio</header>

<div class="stats">
  <div class="card"><span>Vues</span><h2 id="views">0</h2></div>
  <div class="card"><span>Vid√©os</span><h2 id="videos">0</h2></div>
  <div class="card"><span>Abonn√©s</span><h2 id="subs">0</h2></div>
  <div class="card"><span>Likes</span><h2 id="likes">0</h2></div>
  <div class="card"><span>Commentaires</span><h2 id="comments">0</h2></div>
  <div class="card"><span>Revenus totaux</span><h2 id="revenue">$0</h2></div>
</div>

<div class="revenue">
  <div>üì∫ Revenus CPM : <b id="revPub">$0</b></div>
  <div>‚ù§Ô∏è Revenus dons : <b id="revDon">$0</b></div>
  <div>üí∞ Taxe mensuelle : <b id="tax">-$0</b></div>
</div>

<table>
  <thead>
    <tr>
      <th>Titre</th>
      <th>Vues</th>
      <th>Likes</th>
      <th>Commentaires</th>
      <th>Revenu pub</th>
    </tr>
  </thead>
  <tbody id="videoTable"></tbody>
</table>

</body>
</html>
