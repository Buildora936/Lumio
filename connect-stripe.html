<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Connexion Stripe</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
 margin:0;
 font-family:system-ui;
 background:#0f172a;
 color:white;
 display:flex;
 align-items:center;
 justify-content:center;
 height:100vh;
}
.card{
 background:#111827;
 padding:30px;
 border-radius:14px;
 width:380px;
 text-align:center;
}
button{
 width:100%;
 margin-top:15px;
 padding:12px;
 border-radius:10px;
 border:none;
 background:#635bff;
 color:white;
 font-weight:600;
 cursor:pointer;
}
.status{
 margin-top:15px;
 padding:10px;
 border-radius:10px;
}
.ok{background:#065f46}
.warn{background:#92400e}
.err{background:#7f1d1d}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

const config={
 apiKey:"AIzaSyD5uZ2jt01wJVCWfjdJ6IFa5fAVbdfoI_c",
 authDomain:"lumio-6efed.firebaseapp.com",
 projectId:"lumio-6efed"
};

const app=initializeApp(config);
const auth=getAuth(app);

let user=null;

const box=()=>document.getElementById("status");

function status(msg,type){
 box().className="status "+type;
 box().textContent=msg;
}

async function checkStripe(){
 try{
  const token=await user.getIdToken();

  const res=await fetch(
   "https://ymcrkbcsuloijemdbqzy.supabase.co/functions/v1/check-stripe-status",
   {
    method:"POST",
    headers:{
     "Content-Type":"application/json",
     "Authorization":"Bearer "+token
    },
    body:JSON.stringify({uid:user.uid})
   }
  );

  const d=await res.json();

  if(!d.accountExists){
   status("Compte non connecté","warn");
   return;
  }

  if(d.chargesEnabled && d.payoutsEnabled){
   status("Stripe actif ✔","ok");
   continueBtn.style.display="block";
   connectBtn.style.display="none";
  }
  else{
   status("Vérification Stripe requise","warn");
  }

 }catch{
  status("Erreur vérification","err");
 }
}

onAuthStateChanged(auth,u=>{
 if(!u)return location.href="login.html";
 user=u;
 checkStripe();
});

window.connectStripe=async()=>{
 connectBtn.disabled=true;
 connectBtn.textContent="Connexion...";

 try{
  const token=await user.getIdToken();

  const res=await fetch(
   "https://ymcrkbcsuloijemdbqzy.supabase.co/functions/v1/create-stripe-account",
   {
    method:"POST",
    headers:{
     "Content-Type":"application/json",
     "Authorization":"Bearer "+token
    },
    body:JSON.stringify({uid:user.uid,email:user.email})
   }
  );

  const d=await res.json();
  if(!d.url)throw 0;

  location.href=d.url;

 }catch{
  status("Erreur connexion Stripe","err");
  connectBtn.disabled=false;
  connectBtn.textContent="Connecter Stripe";
 }
}
</script>
</head>

<body>

<div class="card">
<h2>Activer la monétisation</h2>
<p>Connecte Stripe pour recevoir tes paiements</p>

<button id="connectBtn" onclick="connectStripe()">Connecter Stripe</button>
<div id="status" class="status"></div>

<button id="continueBtn" style="display:none" onclick="location.href='dashboard.html'">
Continuer
</button>
</div>

</body>
</html>
